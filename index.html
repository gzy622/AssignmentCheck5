<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰Ωú‰∏öÊèê‰∫§ËøΩË∏™Â∑•ÂÖ∑ PSA</title>
    <style>
        :root {
            --primary: #4f46e5;
            --success: #22c55e;
            --warning: #f59e0b;
            --late: #3b82f6;
            --danger: #ef4444;
            --status-submitted: #22c55e;
            --status-late: #3b82f6;
            --status-missing: #ef4444;
            --status-pending: #6B7280;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: 0.15s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        html {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* È°∂ÈÉ®ËøõÂ∫¶Êù° - ÁéØÂ¢ÉÊÑüÁü• */
        .ambient-progress {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--border);
            z-index: 1000;
        }

        .ambient-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Â§¥ÈÉ® */
        .header {
            background: var(--card);
            padding: 6px 12px;
            box-shadow: var(--shadow);
            z-index: 100;
            flex-shrink: 0;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0;
            gap: 8px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--primary);
            color: white;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            min-width: 32px;
            height: 18px;
        }

        .badge.success { background: var(--success); }
        .badge.warning { background: var(--warning); }

        .header-actions {
            display: flex;
            gap: 6px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .icon-btn:hover { background: var(--bg); }
        .icon-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .icon-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .date-nav.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Êó•ÊúüÈÄâÊã©Âô® */
        .date-trigger {
            flex: 1;
            min-width: 0;
            max-width: 52%;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 13px;
            background: var(--card);
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition);
        }

        .header-stat {
            width: 36px;
            height: 32px;
            padding: 0;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card);
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .date-trigger:hover {
            border-color: var(--primary);
        }

        .date-trigger-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .date-trigger-primary {
            font-size: 15px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .date-trigger-secondary {
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-panel {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .calendar-panel.show {
            opacity: 1;
            visibility: visible;
        }

        .calendar-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--card);
            padding: 12px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transform: translateY(-100%);
            transition: transform 0.2s ease;
        }

        .calendar-panel.show .calendar-content {
            transform: translateY(0);
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px;
        }

        .calendar-month {
            font-size: 16px;
            font-weight: 600;
        }

        .calendar-close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: var(--transition);
        }

        .calendar-close-btn:active {
            background: var(--bg);
        }

        .calendar-nav {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .calendar-nav:active {
            background: var(--bg);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 4px;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
            padding: 4px 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg);
        }

        .calendar-day.other-month {
            color: var(--text-secondary);
            opacity: 0.4;
        }

        .calendar-day.today {
            font-weight: 600;
            color: var(--primary);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }

        .calendar-day .day-marker {
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .calendar-day.today .day-marker,
        .calendar-day.selected .day-marker {
            background: var(--primary);
        }

        .calendar-day.selected .day-marker {
            background: white;
        }

        .calendar-body {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .calendar-footer {
            padding-top: 12px;
            border-top: 1px solid var(--border);
            margin-top: 12px;
        }

        .text-input {
            width: 100%;
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
            font-size: 13px;
            color: var(--text);
            transition: var(--transition);
        }

        .text-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .date-nav-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .date-nav {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }

        /* ‰∏ªÂÜÖÂÆπÂå∫ */
        .main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 8px;
            -webkit-overflow-scrolling: touch;
        }

        /* Â≠¶ÁîüÁΩëÊ†º */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            transition: var(--transition);
        }

        .student-grid.disabled .student-card {
            opacity: 0.45;
            filter: grayscale(0.6);
        }

        .no-assignment-tip {
            margin: 8px;
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            background: var(--card);
            border: 1px dashed var(--border);
            color: var(--text-secondary);
            font-size: 12px;
            display: none;
        }

        .no-assignment-tip.show {
            display: block;
        }

        /* ÊâπÈáèÊìç‰ΩúÊ†è */
        .bulk-bar {
            position: fixed;
            left: 8px;
            right: 8px;
            bottom: 8px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
            z-index: 900;
            transform: translateY(110%);
            transition: transform 0.2s ease;
        }

        .bulk-bar.show {
            transform: translateY(0);
        }

        body.bulk-mode .main {
            padding-bottom: 84px;
        }

        .bulk-left {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .bulk-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .bulk-count {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 0 4px;
        }

        .bulk-btn {
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .bulk-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .bulk-btn.submitted { background: var(--status-submitted); color: white; border-color: var(--status-submitted); }
        .bulk-btn.late { background: var(--status-late); color: white; border-color: var(--status-late); }
        .bulk-btn.missing { background: var(--status-missing); color: white; border-color: var(--status-missing); }
        .bulk-btn.pending { background: var(--card); color: var(--status-pending); border-color: var(--status-pending); }

        /* Â≠¶ÁîüÂç°Áâá */
        .student-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            user-select: none;
            border: 2px solid transparent;
        }

        .student-card:active {
            transform: scale(0.97);
        }

        .student-card.submitted {
            border-color: var(--status-submitted);
        }

        .student-card.late {
            border-color: var(--status-late);
        }

        .student-card.missing {
            border-color: var(--status-missing);
        }

        .student-card {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3px;
        }

        .student-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary) inset;
        }

        .student-card.selected::after {
            content: "‚úì";
            position: absolute;
            top: 3px;
            left: 3px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compact-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 2px;
            transition: var(--transition);
        }

        .student-card.submitted .compact-avatar {
            background: var(--status-submitted);
            color: white;
        }

        .student-card.late .compact-avatar {
            background: var(--status-late);
            color: white;
        }

        .compact-id {
            font-size: 9px;
            color: var(--text-secondary);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .compact-score {
            position: absolute;
            top: 1px;
            right: 1px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .student-grid.fullname .student-card {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 4px 3px 3px;
            gap: 2px;
        }

        .fullname-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .student-card.submitted .fullname-avatar {
            background: var(--status-submitted);
            color: white;
        }

        .student-card.late .fullname-avatar {
            background: var(--status-late);
            color: white;
        }

        .fullname-info {
            text-align: center;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            min-height: 0;
        }

        .fullname-name {
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text);
            line-height: 1.3;
            width: 100%;
        }

        .fullname-id {
            font-size: 9px;
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .fullname-score {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* ËØÑÂàÜÂºπÁ™ó */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card);
            width: 100%;
            max-width: 420px;
            height: 92vh;
            overflow-y: auto;
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 12px;
            transform: translateY(100%);
            transition: transform 0.2s ease;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-close {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
            cursor: pointer;
            font-size: 14px;
            flex-shrink: 0;
        }

        .score-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 12px;
            background: var(--bg);
            border-radius: var(--radius);
            padding: 8px 10px;
        }

        .student-info-modal {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .student-info-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .student-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-number {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 1px;
        }

        .score-section {
            background: var(--bg);
            border-radius: var(--radius);
            padding: 10px;
            margin-bottom: 8px;
        }

        .score-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
            position: relative;
        }

        .score-input {
            width: 120px;
            height: 44px;
            padding: 0;
            font-size: 22px;
            font-weight: 600;
            text-align: center;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card);
            color: var(--text);
            outline: none;
            transition: var(--transition);
            line-height: 1;
        }

        .score-input:focus {
            border-color: var(--primary);
        }

        .score-input::-webkit-outer-spin-button,
        .score-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .score-input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .score-clear-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: absolute;
            right: calc(50% - 60px - 36px);
            top: 50%;
            transform: translateY(-50%);
        }

        .score-clear-btn:active {
            background: var(--border);
        }

        .status-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .status-btn {
            padding: 10px 6px;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border);
            background: var(--card);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .status-btn.submitted { border-color: var(--status-submitted); color: var(--status-submitted); }
        .status-btn.submitted.active { background: var(--status-submitted); color: white; }
        .status-btn.late { border-color: var(--status-late); color: var(--status-late); }
        .status-btn.late.active { background: var(--status-late); color: white; }
        .status-btn.missing { border-color: var(--status-missing); color: var(--status-missing); }
        .status-btn.missing.active { background: var(--status-missing); color: white; }
        .status-btn.pending { border-color: var(--status-pending); color: var(--status-pending); }
        .status-btn.pending.active { background: var(--status-pending); color: white; }

        .numpad {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .numpad-row {
            display: flex;
            gap: 6px;
        }

        .numpad-btn {
            flex: 1;
            padding: 14px 8px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--card);
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .numpad-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .numpad-btn.numpad-func {
            background: var(--border);
            font-size: 18px;
        }

        .numpad-btn.numpad-primary {
            background: var(--primary);
            color: white;
        }

        body.high-contrast .numpad-btn {
            border: 2px solid var(--border);
        }

        .score-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .score-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 12px;
            font-size: 14px;
        }

        .numpad {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background: var(--bg);
            border-radius: var(--radius);
            margin-bottom: 12px;
        }

        .numpad-row {
            display: flex;
            gap: 8px;
        }

        .numpad-btn {
            flex: 1;
            padding: 16px 8px;
            font-size: 22px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--card);
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .numpad-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .numpad-btn.num {
            background: var(--card);
        }

        .numpad-btn.numpad-func {
            background: var(--border);
            font-size: 20px;
        }

        .numpad-btn.numpad-action {
            background: var(--warning);
            color: white;
            font-size: 16px;
        }

        .numpad-btn.numpad-primary {
            background: var(--primary);
            color: white;
            font-size: 16px;
        }

        body.high-contrast .numpad-btn {
            border: 2px solid var(--border);
        }

        body.high-contrast .numpad-btn.numpad-primary {
            background: var(--primary);
            color: black;
        }

        .btn {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover { opacity: 0.9; }

        .btn-secondary {
            background: var(--card);
            color: var(--text);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* ËÆæÁΩÆÈù¢Êùø */
        .settings-panel {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .settings-panel.show {
            transform: translateX(0);
        }

        .settings-header {
            background: var(--card);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .settings-section {
            background: var(--card);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }

        .settings-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-item:last-child { border-bottom: none; }
        .settings-item-main { min-width: 0; flex: 1; }
        .settings-action-item { cursor: pointer; transition: var(--transition); }
        .settings-action-item:active { background: var(--bg); }
        .settings-action-item:focus-visible,
        .switch:focus-visible,
        .assignment-item:focus-visible,
        .stats-collapse:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
        }
        .settings-nav-indicator {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border);
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
            flex-shrink: 0;
            transition: var(--transition);
        }
        .settings-action-item:hover .settings-nav-indicator,
        .settings-action-item:active .settings-nav-indicator {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--bg);
        }
        .settings-action-badge {
            min-width: 42px;
            height: 28px;
            padding: 0 10px;
            border: 1px solid var(--border);
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
            transition: var(--transition);
        }
        .settings-action-item:hover .settings-action-badge,
        .settings-action-item:active .settings-action-badge {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--bg);
        }

        .settings-label { font-size: 15px; }

        .settings-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .assignment-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .assignment-item {
            padding: 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .assignment-item:hover {
            border-color: var(--primary);
        }

        .assignment-item.active {
            border-color: var(--primary);
            background: var(--bg);
        }

        .assignment-item-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .assignment-item-name {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .assignment-item-meta {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .range-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .range-row .text-input {
            width: 70px;
            text-align: center;
        }

        /* ÂàáÊç¢ÂºÄÂÖ≥ */
        .switch {
            width: 48px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
        }

        .switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .switch.on {
            background: var(--primary);
        }

        .switch.on::after {
            transform: translateX(22px);
        }

        /* ÊñáÊú¨Âå∫Âüü */
        .textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: monospace;
            resize: vertical;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-group .btn { flex: 1; justify-content: center; }

        /* ÁªüËÆ°Èù¢Êùø */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .stats-list-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
        }

        .stats-list-name {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stats-list-sub {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .stats-dots {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .stats-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border);
            position: relative;
        }

        .stats-dot:hover::after,
        .stats-dot:focus::after,
        .stats-dot:active::after {
            content: attr(data-title);
            position: absolute;
            bottom: 140%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text);
            color: var(--card);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 6px;
            white-space: nowrap;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .stats-dot.submitted { background: var(--status-submitted); }
        .stats-dot.late {
            border-radius: 50%;
            border: none;
            background: var(--status-late);
        }
        .stats-dot.missing {
            border-radius: 50%;
            border: none;
            background: var(--status-missing);
        }
        .stats-dot.pending {
            border-radius: 50%;
            border: 1px solid var(--status-pending);
            background: radial-gradient(circle, #ffffff 0 42%, var(--status-pending) 45% 100%);
        }

        .stats-collapse {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats-collapse .collapse-arrow {
            transition: transform 0.2s ease;
        }

        .stats-collapse.collapsed .collapse-arrow {
            transform: rotate(-90deg);
        }

        .stats-collapse-body {
            display: block;
        }

        .stats-collapse-body.collapsed {
            display: none;
        }

        .stats-list-status {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .stats-list-status.submitted {
            border-color: var(--status-submitted);
            color: var(--status-submitted);
        }

        .stats-list-status.late {
            border-color: var(--status-late);
            color: var(--status-late);
        }

        .stats-list-status.missing {
            border-color: var(--status-missing);
            background: var(--status-missing);
            color: white;
            font-weight: 700;
        }

        .stat-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }


        .calendar-nav {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .calendar-nav:active {
            background: var(--bg);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 4px;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
            padding: 4px 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg);
        }

        .calendar-day.other-month {
            color: var(--text-secondary);
            opacity: 0.4;
        }

        .calendar-day.today {
            font-weight: 600;
            color: var(--primary);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }

        .calendar-day .day-marker {
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .calendar-day.today .day-marker,
        .calendar-day.selected .day-marker {
            background: var(--primary);
        }

        .calendar-day.selected .day-marker {
            background: white;
        }

        .calendar-close {
            margin-top: 12px;
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-close:active {
            background: var(--bg);
        }

        /* ÊèêÁ§∫‰ø°ÊÅØ */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(30, 41, 59, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* È´òÂØπÊØîÂ∫¶Ê®°Âºè */
        body.high-contrast {
            --bg: #000000;
            --card: #111111;
            --text: #ffffff;
            --text-secondary: #aaaaaa;
            --border: #444444;
            --primary: #00ff00;
            --success: #00ff00;
            --warning: #ffff00;
            --danger: #ff0000;
        }

        body.high-contrast .student-card {
            border-width: 3px;
        }

        body.high-contrast .icon-btn,
        body.high-contrast .btn,
        body.high-contrast .date-nav {
            border-width: 2px;
        }

        body.high-contrast .date-trigger {
            color: var(--text);
            border-color: var(--text);
        }

        body.high-contrast .date-trigger-secondary {
            color: var(--text);
        }

        body.high-contrast .header-stat {
            color: var(--text);
            border-color: var(--text);
        }

        body.high-contrast .btn {
            color: var(--text);
            border-color: var(--text);
        }

        body.high-contrast .btn-primary {
            color: #000000;
            border-color: var(--primary);
        }

        body.high-contrast .calendar-nav {
            color: var(--text);
            border-color: var(--text);
        }

        body.high-contrast .date-nav {
            color: var(--text);
            border-color: var(--text);
        }

        body.high-contrast .icon-btn {
            color: var(--text);
            border-color: var(--text);
            background: var(--card);
        }

        body.high-contrast .status-btn.pending {
            color: var(--text);
            border-color: var(--text);
        }

        body.high-contrast .status-btn.pending.active {
            background: var(--text);
            color: var(--bg);
        }

        body.high-contrast .calendar-close {
            color: var(--text);
            border-color: var(--text);
        }

        body.high-contrast .modal-close {
            color: var(--text);
            border-color: var(--text);
            background: var(--card);
        }

        body.high-contrast .assignment-item,
        body.high-contrast .text-input {
            color: var(--text);
            border-color: var(--text);
        }

        body.high-contrast .assignment-item-meta {
            color: var(--text);
        }

        /* ÈöêËóèÂä®Áîª */
        body.no-animation * {
            transition: none !important;
            animation: none !important;
        }

        /* ÂìçÂ∫îÂºè */
        @media (min-width: 768px) {
            .student-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 8px;
            }
        }

        /* ÊªöÂä®Êù°ÁæéÂåñ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- ÁéØÂ¢ÉËøõÂ∫¶Êù° -->
    <div class="ambient-progress">
        <div class="ambient-progress-bar" id="progressBar"></div>
    </div>

    <!-- Â§¥ÈÉ® -->
    <header class="header">
        <div class="header-top">
            <button class="date-trigger" id="dateTrigger" aria-label="ÈÄâÊã©Êó•ÊúüÂíå‰Ωú‰∏ö">
                <span class="date-trigger-info">
                    <span class="date-trigger-primary" id="dateTriggerPrimary">‰Ωú‰∏ö</span>
                    <span class="date-trigger-secondary" id="dateTriggerSecondary">2026-02-03 ‰ªäÂ§©</span>
                </span>
            </button>
            <div class="header-stat" id="headerSubmitted">
                <span class="header-stat-value" id="headerSubmittedValue">0</span>
            </div>
            <div class="date-nav-group">
                <button class="date-nav" id="toggleViewMode" title="ÂàáÊç¢ÊòæÁ§∫Ê®°Âºè" aria-label="ÂàáÊç¢ÊòæÁ§∫Ê®°Âºè">üë§</button>
                <button class="date-nav" id="toggleBulk" title="ÊâπÈáèÈÄâÊã©" aria-label="ÊâπÈáèÈÄâÊã©">‚òë</button>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="menuBtn" title="ËèúÂçï" aria-label="ÊâìÂºÄËèúÂçï">‚ò∞</button>
            </div>
        </div>
    </header>

    <!-- Êó•ÂéÜÈù¢Êùø -->
    <div class="calendar-panel" id="calendarPanel">
        <div class="calendar-content">
            <div class="calendar-header">
                <button class="calendar-nav" id="calendarPrevMonth" aria-label="‰∏ä‰∏™Êúà">‚óÄ</button>
                <span class="calendar-month" id="calendarMonth">2026Âπ¥2Êúà</span>
                <button class="calendar-nav" id="calendarNextMonth" aria-label="‰∏ã‰∏™Êúà">‚ñ∂</button>
                <button class="calendar-close-btn" id="calendarClose" aria-label="ÂÖ≥Èó≠Êó•ÂéÜ">‚úï</button>
            </div>
            <div class="calendar-body">
                <div class="calendar-weekdays">
                    <div class="calendar-weekday">Êó•</div>
                    <div class="calendar-weekday">‰∏Ä</div>
                    <div class="calendar-weekday">‰∫å</div>
                    <div class="calendar-weekday">‰∏â</div>
                    <div class="calendar-weekday">Âõõ</div>
                    <div class="calendar-weekday">‰∫î</div>
                    <div class="calendar-weekday">ÂÖ≠</div>
                </div>
                <div class="calendar-days" id="calendarDays"></div>
            </div>
            <div class="calendar-footer">
                <div class="settings-section">
                    <div class="settings-title">‰Ωú‰∏ö</div>
                    <input class="text-input" id="assignmentNameInput" placeholder="‰Ωú‰∏öÂêçÁß∞" aria-label="‰Ωú‰∏öÂêçÁß∞">
                    <div class="btn-group" style="margin-top: 8px;">
                        <button class="btn btn-primary" id="saveAssignmentName">‰øùÂ≠òÂêçÁß∞</button>
                        <button class="btn" id="createAssignmentBtn">Ôºã Êñ∞Âª∫ËØ•Êó•‰Ωú‰∏ö</button>
                    </div>
                    <div class="settings-desc" id="assignmentMeta" style="margin-top: 8px;">-</div>
                    <div class="settings-desc" style="margin-top: 4px;">ÁÇπÂáªÂàóË°®ÂàáÊç¢‰Ωú‰∏ö</div>
                    <div class="assignment-list" id="assignmentList" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπ -->
    <main class="main">
        <div class="no-assignment-tip" id="noAssignmentTip">ËØ•Êó•ÊúüÊöÇÊó†‰Ωú‰∏öÔºåËØ∑ÂÖàÂú®Êó•ÂéÜÈù¢Êùø‰∏≠Êñ∞Âª∫‰Ωú‰∏ö„ÄÇ</div>
        <div class="student-grid" id="studentGrid"></div>
    </main>

    <div class="bulk-bar" id="bulkBar">
        <div class="bulk-left">
            <span class="bulk-count" id="bulkCount">Â∑≤ÈÄâ 0</span>
            <button class="bulk-btn" id="bulkSelectAll">ÂÖ®ÈÄâ</button>
            <button class="bulk-btn" id="bulkClear">Ê∏ÖÁ©∫</button>
        </div>
        <div class="bulk-actions">
            <button class="bulk-btn submitted" data-bulk-status="submitted">Â∑≤‰∫§</button>
            <button class="bulk-btn late" data-bulk-status="late">Ëøü‰∫§</button>
            <button class="bulk-btn missing" data-bulk-status="missing">Êú™‰∫§</button>
            <button class="bulk-btn pending" data-bulk-status="pending">ÂèñÊ∂à</button>
        </div>
    </div>

    <!-- ËØÑÂàÜÂºπÁ™ó -->
    <div class="modal-overlay" id="scoreModal">
        <div class="modal-content">
            <div class="score-header">
                <div class="student-info-modal">
                    <div class="student-info-avatar">?</div>
                    <div>
                        <div class="student-name" id="modalStudentName">Â≠¶ÁîüÂßìÂêç</div>
                        <div class="student-number" id="modalStudentId">Â≠¶Âè∑</div>
                    </div>
                </div>
                <button class="modal-close" id="closeModal" aria-label="ÂÖ≥Èó≠ËØÑÂàÜÂºπÁ™ó">‚úï</button>
            </div>
            
            <div class="score-section">
                <div class="score-row">
                    <input type="text" class="score-input" id="scoreInput" placeholder="-" inputmode="none" readonly aria-label="ÂàÜÊï∞ËæìÂÖ•Ê°Ü" onfocus="this.removeAttribute('readonly');">
                    <button class="score-clear-btn" data-action="clear" title="Ê∏ÖÁ©∫">‚úï</button>
                </div>
                <div class="numpad">
                    <div class="numpad-row">
                        <button class="numpad-btn" data-action="num">1</button>
                        <button class="numpad-btn" data-action="num">2</button>
                        <button class="numpad-btn" data-action="num">3</button>
                    </div>
                    <div class="numpad-row">
                        <button class="numpad-btn" data-action="num">4</button>
                        <button class="numpad-btn" data-action="num">5</button>
                        <button class="numpad-btn" data-action="num">6</button>
                    </div>
                    <div class="numpad-row">
                        <button class="numpad-btn" data-action="num">7</button>
                        <button class="numpad-btn" data-action="num">8</button>
                        <button class="numpad-btn" data-action="num">9</button>
                    </div>
                    <div class="numpad-row">
                        <button class="numpad-btn numpad-func" data-action="decimal">.</button>
                        <button class="numpad-btn" data-action="num">0</button>
                        <button class="numpad-btn numpad-func" data-action="backspace">‚å´</button>
                    </div>
                </div>
            </div>

            <div class="score-section">
                <div class="status-options">
                    <button class="status-btn submitted" data-status="submitted">Â∑≤‰∫§</button>
                    <button class="status-btn late" data-status="late">Ëøü‰∫§</button>
                    <button class="status-btn missing" data-status="missing">Êú™‰∫§</button>
                    <button class="status-btn pending" data-status="pending">ÂèñÊ∂à</button>
                </div>
            </div>
            
        </div>
    </div>

    <!-- ÁªüËÆ°Èù¢Êùø -->
    <div class="settings-panel" id="statsPanel">
        <div class="settings-header">
            <span style="font-size: 18px; font-weight: 600;">ÁªüËÆ°</span>
            <button class="icon-btn" id="closeStats" aria-label="ÂÖ≥Èó≠ÁªüËÆ°Èù¢Êùø">‚úï</button>
        </div>
        <div class="settings-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">ÊÄª‰∫∫Êï∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statSubmitted">0</div>
                    <div class="stat-label">Â∑≤Êèê‰∫§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statRate">0%</div>
                    <div class="stat-label">Êèê‰∫§Áéá</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAvg">-</div>
                    <div class="stat-label">Âπ≥ÂùáÂàÜ</div>
                </div>
            </div>
            <div class="settings-desc" id="statsAssignmentName" style="margin-top: 12px;">ÂΩìÂâç‰Ωú‰∏öÔºö-</div>
            <div class="settings-section">
                <div class="settings-title stats-collapse" id="statsCollapse" role="button" tabindex="0" data-keyboard-click aria-expanded="true" aria-controls="statsCollapseBody">
                    Êèê‰∫§ÊòéÁªÜ
                    <span class="collapse-arrow">‚ñº</span>
                </div>
                <div class="stats-collapse-body" id="statsCollapseBody">
                    <div class="stats-list-sub" style="margin-bottom: 8px;">
                        ‰ªéÂ∑¶Âà∞Âè≥ÔºöÊñ∞‚ÜíÊóß
                        ¬∑
                        <span style="display:inline-flex; align-items:center; gap:4px; margin-left:4px;">
                            <span class="stats-dot submitted"></span>Â∑≤‰∫§
                            <span class="stats-dot late"></span>Ëøü‰∫§
                            <span class="stats-dot missing"></span>Êú™‰∫§
                            <span class="stats-dot pending"></span>Êú™ÁôªËÆ∞
                        </span>
                    </div>
                    <div class="stats-list" id="statsStudentList"></div>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">ÂéÜÂè≤Ë∂ãÂäø</div>
                <div class="range-row" style="margin-bottom: 12px;">
                    <span class="settings-desc" style="margin-top: 0;">ÊòæÁ§∫ÊúÄËøë</span>
                    <input class="text-input" id="historyRangeInput" type="number" min="1" max="50" inputmode="numeric">
                    <span class="settings-desc" style="margin-top: 0;">È°π‰Ωú‰∏ö</span>
                    <button class="btn" id="applyHistoryRange">Â∫îÁî®</button>
                </div>
                <div id="historyChart" style="height: 200px; display: flex; align-items: flex-end; justify-content: space-around; padding: 20px 0;"></div>
            </div>
        </div>
    </div>

    <!-- ÂØºÂÖ•/ÂØºÂá∫Èù¢Êùø -->
    <div class="settings-panel" id="dataPanel">
        <div class="settings-header">
            <span style="font-size: 18px; font-weight: 600;">Êï∞ÊçÆÂØºÂÖ•/ÂØºÂá∫</span>
            <button class="icon-btn" id="closeData" aria-label="ÂÖ≥Èó≠Êï∞ÊçÆÈù¢Êùø">‚úï</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-title">ÂØºÂÖ•Êï∞ÊçÆ</div>
                <div class="settings-desc" style="margin-bottom: 12px;">Á≤òË¥¥ JSON / CSV Êï∞ÊçÆÊàñÂ≠¶ÁîüÂêçÂçïÔºàÊØèË°å‰∏Ä‰∏™Ôºâ</div>
                <textarea class="textarea" id="importText" placeholder='{"students":[{"id":"1","name":"Âº†‰∏â"}],"assignments":[{"id":"a1","name":"24/02/03‰Ωú‰∏ö1","date":"2024-02-03","order":1,"createdAt":1700000000000}],"records":{"a1":{}},"settings":{"historyCount":7},"version":"2.0.0"}'></textarea>
                <div class="btn-group">
                    <button class="btn btn-primary" id="confirmImport">Á°ÆËÆ§ÂØºÂÖ•</button>
                    <button class="btn" id="clearImport">Ê∏ÖÁ©∫</button>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">ÂØºÂá∫Êï∞ÊçÆ</div>
                <div class="settings-desc" style="margin-bottom: 12px;">ÈÄâÊã© JSON Êàñ CSV Â§çÂà∂Â§á‰ªΩ</div>
                <div class="btn-group" style="margin-bottom: 8px;">
                    <button class="btn btn-primary" id="exportJsonBtn">ÂØºÂá∫ JSON</button>
                    <button class="btn" id="exportCsvBtn">ÂØºÂá∫ CSV</button>
                </div>
                <textarea class="textarea" id="exportText" readonly></textarea>
                <button class="btn btn-primary" id="copyData" style="width: 100%; margin-top: 12px;">üìã Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø</button>
            </div>
        </div>
    </div>

    <!-- ‰∏ªËèúÂçïÈù¢Êùø -->
    <div class="settings-panel" id="menuPanel">
        <div class="settings-header">
            <span style="font-size: 18px; font-weight: 600;">ËèúÂçï</span>
            <button class="icon-btn" id="closeMenu" aria-label="ÂÖ≥Èó≠ËèúÂçï">‚úï</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-title">Êï∞ÊçÆ</div>
                <div class="settings-item settings-action-item" id="dataItem" role="button" tabindex="0" data-keyboard-click aria-label="ÂØºÂÖ•ÊàñÂØºÂá∫Êï∞ÊçÆ">
                    <div class="settings-item-main">
                        <div class="settings-label">ÂØºÂÖ•/ÂØºÂá∫Êï∞ÊçÆ</div>
                        <div class="settings-desc">ÊîØÊåÅ JSON/CSV ÂØºÂÖ•‰∏éÂØºÂá∫</div>
                    </div>
                    <span class="settings-nav-indicator" aria-hidden="true">‚Ä∫</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">ÊòæÁ§∫</div>
                <div class="settings-item">
                    <div class="settings-item-main">
                        <div class="settings-label">ÂÆåÊï¥ÂßìÂêç</div>
                        <div class="settings-desc">ÊòæÁ§∫Â≠¶ÁîüÂÖ®ÂêçÂíåÂ≠¶Âè∑</div>
                    </div>
                    <div class="switch" id="fullnameSwitch" role="switch" tabindex="0" data-keyboard-click aria-checked="false" aria-label="ÂÆåÊï¥ÂßìÂêç"></div>
                </div>
                <div class="settings-item">
                    <div class="settings-item-main">
                        <div class="settings-label">È´òÂØπÊØîÂ∫¶Ê®°Âºè</div>
                        <div class="settings-desc">ÈÄÇÂ∫îÂº∫ÂÖâÁéØÂ¢É</div>
                    </div>
                    <div class="switch" id="contrastSwitch" role="switch" tabindex="0" data-keyboard-click aria-checked="false" aria-label="È´òÂØπÊØîÂ∫¶Ê®°Âºè"></div>
                </div>
                <div class="settings-item">
                    <div class="settings-item-main">
                        <div class="settings-label">Á¶ÅÁî®Âä®Áîª</div>
                        <div class="settings-desc">ÊèêÂçáËÄÅÊóßËÆæÂ§áÊÄßËÉΩ</div>
                    </div>
                    <div class="switch" id="animationSwitch" role="switch" tabindex="0" data-keyboard-click aria-checked="false" aria-label="Á¶ÅÁî®Âä®Áîª"></div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">Êõ¥Â§ö</div>
                <div class="settings-item settings-action-item" id="markPendingMissingItem" role="button" tabindex="0" data-keyboard-click aria-label="Êú™ÁôªËÆ∞ËΩ¨Êú™‰∫§">
                    <div class="settings-item-main">
                        <div class="settings-label">Êú™ÁôªËÆ∞ËΩ¨Êú™‰∫§</div>
                        <div class="settings-desc">‰∏ÄÈîÆÂ∞ÜÂΩìÂâç‰Ωú‰∏öÊú™ÁôªËÆ∞Ê†áËÆ∞‰∏∫Êú™‰∫§</div>
                    </div>
                    <span class="settings-action-badge">ÊâßË°å</span>
                </div>
                <div class="settings-item settings-action-item" id="assignmentItem" role="button" tabindex="0" data-keyboard-click aria-label="‰Ωú‰∏öÁÆ°ÁêÜ">
                    <div class="settings-item-main">
                        <div class="settings-label">‰Ωú‰∏öÁÆ°ÁêÜ</div>
                        <div class="settings-desc">Êñ∞Â¢û„ÄÅÂàáÊç¢„ÄÅÈáçÂëΩÂêç</div>
                    </div>
                    <span class="settings-nav-indicator" aria-hidden="true">‚Ä∫</span>
                </div>
                <div class="settings-item settings-action-item" id="statsItem" role="button" tabindex="0" data-keyboard-click aria-label="Êü•ÁúãÁªüËÆ°">
                    <div class="settings-item-main">
                        <div class="settings-label">ÁªüËÆ°</div>
                        <div class="settings-desc">Êü•ÁúãÊèê‰∫§ÁªüËÆ°</div>
                    </div>
                    <span class="settings-nav-indicator" aria-hidden="true">‚Ä∫</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">ËÆæÁΩÆ</div>
                <div class="settings-item" style="flex-direction: column; align-items: stretch; gap: 8px;">
                    <div class="settings-label">Êñ∞Â≠¶ÊúüÂàùÂßãÂåñ</div>
                    <div class="settings-desc">Ê∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤Êï∞ÊçÆÔºå‰ΩÜ‰øùÁïôÂ≠¶ÁîüÂêçÂçï</div>
                    <button class="btn" id="resetDataBtn" style="margin-top: 8px; color: var(--danger); border-color: var(--danger);">
                        üóëÔ∏è ÈáçÁΩÆÊï∞ÊçÆ
                    </button>
                </div>
                <div class="settings-item">
                    <div class="settings-label">ÁâàÊú¨</div>
                    <span style="color: var(--text-secondary);">2.0.0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊèêÁ§∫‰ø°ÊÅØ -->
    <div class="toast" id="toast"></div>

    <script>
        function getLocalDateString(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // ============ Êï∞ÊçÆÁÆ°ÁêÜ ============
        const DataManager = {
            STORAGE_KEY: 'psa_data_v2',

            generateAssignmentId() {
                return `A${Date.now().toString(36)}${Math.random().toString(36).slice(2, 6)}`;
            },

            formatAssignmentName(dateStr, order) {
                const [y, m, d] = dateStr.split('-');
                return `${y.slice(2)}/${m}/${d}‰Ωú‰∏ö${order}`;
            },

            createAssignment(dateStr, order, name) {
                return {
                    id: this.generateAssignmentId(),
                    name: name || this.formatAssignmentName(dateStr, order),
                    date: dateStr,
                    order,
                    createdAt: Date.now()
                };
            },
            
            getDefaultData() {
                const today = getLocalDateString(new Date());
                const assignment = this.createAssignment(today, 1);
                return {
                    students: this.generateSampleStudents(),
                    assignments: [assignment],
                    records: { [assignment.id]: {} },
                    settings: {
                        highContrast: false,
                        noAnimation: false,
                        showFullname: false,
                        historyCount: 7
                    },
                    version: '2.0.0'
                };
            },

            generateSampleStudents() {
                const names = ['Âº†Êµ©ÂÆá', 'ÁéãÊ¢ìÊ∂µ', 'ÊùéÊ¨£ÊÄ°', 'ÂàòÂ≠êËΩ©', 'ÈôàÈõ®Ê°ê', 'Êù®Êô®Êõ¶', 'ÈªÑÊÄùÁê™', 'ËµµÊñáÂçö', 'Âë®‰Ω≥ÊÄ°', 'Âê¥‰øäÊù∞',
                    'ÂæêÊ¢¶Ê¥Å', 'Â≠ôÊµ©ÁÑ∂', 'È©¨ÊôìÈõØ', 'Êú±ÂÆáËà™', 'ËÉ°ÈõÖÂ©∑', 'ÊûóÂòâË±™', 'ÈÉ≠Èõ®Ëê±', '‰ΩïÂ≠êÂ¢®', 'È´òËØóÊ∂µ', 'ÁΩó‰∏ÄÈ∏£',
                    'Ê¢ÅÈùôÂßù', 'ÂÆãÊâøÂÆá', 'ÈÉëÂøÉÊÄ°', 'Ë∞¢Â§©‰Ωë', 'Èü©Èõ®Ëè≤', 'ÂîêÂ≠êË±™', 'ÂÜØÊôìËê±', '‰∫éÂòâÊ†ë', 'Ëë£ÊÄùÁê™', 'ËêßÈÄ∏Ëæ∞',
                    'Á®ãÈõ®Ëêå', 'ÊõπÂ≠êÊ∂µ', 'Ë¢ÅËâ∫È¶®', 'ÈÇìÂçöÊñá', 'ËÆ∏‰Ω≥Áê™', 'ÂÇÖÊòéËΩ©', 'Ê≤àÊÇ¶Áê≥', 'ÊõæÊµ©ÁÑ∂', 'ÂΩ≠Èõ®Ê°ê', 'ÂêïÊÄùËøú',
                    'Áß¶Â≠êÁëú', 'ËãèËã•Êõ¶', 'Âè∂Ê∏ÖÊ¨¢', 'È°æÊ≥ΩÂÆá', 'ÊûóËØ≠Â´£', 'Âë®ÊÖïÁôΩ', 'Èü©Ê≤êÊô®', 'ÂîêÂ©âÊ∏Ö', 'ÂßúÈõ®Êô¥', 'ËÆ∏ÊôØËæ∞'];
                return names.map((name, i) => ({
                    id: String(i + 1).padStart(2, '0'),
                    name: name
                }));
            },

            load() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    if (data) {
                        const parsed = JSON.parse(data);
                        if (parsed && Array.isArray(parsed.assignments) && parsed.records && typeof parsed.records === 'object') {
                            const defaults = this.getDefaultData();
                            return {
                                ...defaults,
                                ...parsed,
                                settings: { ...defaults.settings, ...(parsed.settings || {}) }
                            };
                        }
                    }
                } catch (e) {
                    console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', e);
                }
                return this.getDefaultData();
            },

            save(data) {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('‰øùÂ≠òÊï∞ÊçÆÂ§±Ë¥•:', e);
                    return false;
                }
            },

            export() {
                const data = this.load();
                return JSON.stringify(data, null, 2);
            },

            exportCSV(assignmentId) {
                const data = this.load();
                const records = assignmentId ? data.records[assignmentId] || {} : {};
                const rows = [['id', 'name', 'status', 'score']];
                data.students.forEach(student => {
                    const record = records[student.id] || {};
                    const statusText = this.getStatusText(record.status);
                    const scoreText = record.score === null || record.score === undefined ? '' : record.score;
                    rows.push([student.id, student.name, statusText, scoreText]);
                });
                return rows.map(row => row.map(cell => this.escapeCsvValue(cell)).join(',')).join('\n');
            },

            escapeCsvValue(value) {
                if (value === null || value === undefined) return '';
                const text = String(value);
                if (/[",\n]/.test(text)) {
                    return `"${text.replace(/"/g, '""')}"`;
                }
                return text;
            },

            parseCsv(text) {
                const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').filter(line => line.trim());
                if (lines.length === 0) return [];
                const delimiter = this.detectCsvDelimiter(lines[0]);
                return lines.map(line => this.parseCsvLine(line, delimiter));
            },

            detectCsvDelimiter(line) {
                const candidates = [',', '\t', ';'];
                let best = ',';
                let bestCount = -1;
                candidates.forEach(delim => {
                    const count = line.split(delim).length - 1;
                    if (count > bestCount) {
                        bestCount = count;
                        best = delim;
                    }
                });
                return best;
            },

            parseCsvLine(line, delimiter) {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === delimiter && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            },

            getStatusText(status) {
                if (!status) return 'Êú™ÁôªËÆ∞';
                const map = {
                    submitted: 'Â∑≤‰∫§',
                    late: 'Ëøü‰∫§',
                    missing: 'Êú™‰∫§',
                    pending: 'Êú™ÁôªËÆ∞'
                };
                return map[status] || '';
            },

            parseStatusValue(value) {
                if (!value) return 'pending';
                const normalized = String(value).trim().toLowerCase();
                const map = {
                    submitted: 'submitted',
                    late: 'late',
                    missing: 'missing',
                    pending: 'pending',
                    'Â∑≤‰∫§': 'submitted',
                    'Ëøü‰∫§': 'late',
                    'Êú™‰∫§': 'missing',
                    'Êú™ÁôªËÆ∞': 'pending'
                };
                return map[normalized] || 'pending';
            },

            BACKUP_KEY_PREFIX: 'psa_backup_v2_',
            BACKUP_INDEX_KEY: 'psa_backup_v2_index',
            MAX_BACKUPS: 10,

            sanitizeText(value, maxLen = 64) {
                if (value === null || value === undefined) return '';
                return String(value).trim().replace(/\s+/g, ' ').slice(0, maxLen);
            },

            sanitizeStudentId(value, fallback) {
                const text = this.sanitizeText(value, 32);
                return text || this.sanitizeText(fallback, 32);
            },

            buildImportedData(students, records = {}) {
                const today = getLocalDateString(new Date());
                const assignment = this.createAssignment(today, 1);
                return {
                    ...this.getDefaultData(),
                    students,
                    assignments: [assignment],
                    records: { [assignment.id]: records }
                };
            },

            parseJsonImport(rawText) {
                try {
                    const data = JSON.parse(rawText);
                    if (!data || typeof data !== 'object') return null;
                    if (!Array.isArray(data.students) || !Array.isArray(data.assignments) || !data.records || typeof data.records !== 'object') {
                        return null;
                    }

                    const students = data.students
                        .map((s, i) => ({
                            id: this.sanitizeStudentId(s && s.id, String(i + 1).padStart(2, '0')),
                            name: this.sanitizeText(s && s.name, 32) || `Â≠¶Áîü${String(i + 1).padStart(2, '0')}`
                        }))
                        .filter(s => s.id && s.name);

                    const assignments = data.assignments
                        .map((a, i) => {
                            const date = this.sanitizeText(a && a.date, 10);
                            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) return null;
                            return {
                                id: this.sanitizeText(a && a.id, 48) || this.generateAssignmentId(),
                                name: this.sanitizeText(a && a.name, 64) || this.formatAssignmentName(date, i + 1),
                                date,
                                order: Number.isFinite(Number(a && a.order)) ? Number(a.order) : i + 1,
                                createdAt: Number.isFinite(Number(a && a.createdAt)) ? Number(a.createdAt) : Date.now()
                            };
                        })
                        .filter(Boolean);

                    if (students.length === 0 || assignments.length === 0) return null;

                    const normalizedRecords = {};
                    assignments.forEach(assignment => {
                        const source = data.records[assignment.id];
                        const assignmentRecords = {};
                        if (source && typeof source === 'object') {
                            Object.keys(source).forEach(studentId => {
                                const item = source[studentId] || {};
                                const status = this.parseStatusValue(item.status);
                                const score = item.score === null || item.score === undefined || item.score === ''
                                    ? null
                                    : Number(item.score);
                                assignmentRecords[String(studentId)] = {
                                    status,
                                    score: Number.isFinite(score) ? score : null
                                };
                            });
                        }
                        normalizedRecords[assignment.id] = assignmentRecords;
                    });

                    const defaults = this.getDefaultData();
                    return {
                        ...defaults,
                        ...data,
                        students,
                        assignments,
                        records: normalizedRecords,
                        settings: { ...defaults.settings, ...(data.settings || {}) },
                        version: '2.0.0'
                    };
                } catch (e) {
                    return null;
                }
            },

            parseCsvImport(rawText) {
                const csvRows = this.parseCsv(rawText);
                if (csvRows.length < 2) return null;
                if (!csvRows.some(row => row.length >= 2)) return null;

                const header = csvRows[0].map(col => col.trim());
                const knownHeaders = ['id', 'Â≠¶Âè∑', 'ÂßìÂêç', 'name', 'status', 'score', 'Áä∂ÊÄÅ', 'ÂàÜÊï∞'];
                const hasHeader = header.some(col => knownHeaders.includes(col.toLowerCase()));
                const dataRows = hasHeader ? csvRows.slice(1) : csvRows;
                if (dataRows.length === 0) return null;

                const headerMap = {};
                if (hasHeader) {
                    header.forEach((col, index) => {
                        headerMap[col.trim().toLowerCase()] = index;
                    });
                }

                const students = [];
                const records = {};
                dataRows.forEach((row, i) => {
                    if (!row || row.length === 0) return;

                    const rawId = hasHeader ? row[headerMap.id ?? headerMap['Â≠¶Âè∑'] ?? -1] : (row.length > 1 ? row[0] : '');
                    const rawName = hasHeader ? row[headerMap.name ?? headerMap['ÂßìÂêç'] ?? 1] : (row.length > 1 ? row[1] : row[0]);

                    const safeId = this.sanitizeStudentId(rawId, String(i + 1).padStart(2, '0'));
                    const safeName = this.sanitizeText(rawName, 32) || this.sanitizeText(rawId, 32) || `Â≠¶Áîü${safeId}`;
                    if (!safeName) return;

                    students.push({ id: safeId, name: safeName });

                    const statusIndex = headerMap.status ?? headerMap['Áä∂ÊÄÅ'];
                    const scoreIndex = headerMap.score ?? headerMap['ÂàÜÊï∞'];
                    if (hasHeader && (statusIndex !== undefined || scoreIndex !== undefined)) {
                        const statusValue = statusIndex !== undefined ? row[statusIndex] : '';
                        const scoreValue = scoreIndex !== undefined ? row[scoreIndex] : '';
                        const status = this.parseStatusValue(statusValue);
                        const score = scoreValue === undefined || scoreValue === '' ? null : Number(scoreValue);
                        records[safeId] = {
                            status,
                            score: Number.isFinite(score) ? score : null
                        };
                    }
                });

                if (students.length === 0) return null;
                return this.buildImportedData(students, records);
            },

            parseStudentListImport(rawText) {
                const lines = rawText.split('\n').map(line => line.trim()).filter(Boolean);
                if (lines.length < 3) return null;
                if (lines.some(line => /[{}\[\]:]/.test(line))) return null;

                const students = lines.map((line, i) => {
                    const parts = line.split(/[\s,Ôºå]+/).filter(Boolean);
                    if (parts.length >= 2) {
                        const id = this.sanitizeStudentId(parts[0], String(i + 1).padStart(2, '0'));
                        const name = this.sanitizeText(parts.slice(1).join(' '), 32) || `Â≠¶Áîü${id}`;
                        return { id, name };
                    }
                    const id = String(i + 1).padStart(2, '0');
                    const name = this.sanitizeText(line, 32);
                    return { id, name };
                }).filter(s => s.name);

                if (students.length < 3) return null;
                return this.buildImportedData(students, {});
            },

            previewImport(rawText) {
                const text = String(rawText || '').trim();
                if (!text) {
                    return { ok: false, error: 'ÂØºÂÖ•ÂÜÖÂÆπ‰∏∫Á©∫' };
                }

                const jsonData = this.parseJsonImport(text);
                if (jsonData) {
                    return {
                        ok: true,
                        type: 'json',
                        students: jsonData.students.length,
                        assignments: jsonData.assignments.length,
                        data: jsonData
                    };
                }

                const csvData = this.parseCsvImport(text);
                if (csvData) {
                    return {
                        ok: true,
                        type: 'csv',
                        students: csvData.students.length,
                        assignments: csvData.assignments.length,
                        data: csvData
                    };
                }

                const listData = this.parseStudentListImport(text);
                if (listData) {
                    return {
                        ok: true,
                        type: 'list',
                        students: listData.students.length,
                        assignments: listData.assignments.length,
                        data: listData
                    };
                }

                return { ok: false, error: 'Êú™ËØÜÂà´‰∏∫ÊúâÊïà JSON/CSV/Â≠¶ÁîüÂêçÂçïÔºàÂêçÂçïËá≥Â∞ë 3 Ë°åÔºâ' };
            },

            applyImport(preview) {
                if (!preview || !preview.ok || !preview.data) {
                    return { ok: false, error: 'ÂØºÂÖ•È¢ÑÊ£ÄÂ§±Ë¥•' };
                }
                const saved = this.save(preview.data);
                if (!saved) {
                    return { ok: false, error: 'ÂÜôÂÖ•Êú¨Âú∞Â≠òÂÇ®Â§±Ë¥•' };
                }
                return { ok: true };
            },

            backupCurrentData() {
                try {
                    const snapshot = localStorage.getItem(this.STORAGE_KEY);
                    if (!snapshot) return null;

                    const key = `${this.BACKUP_KEY_PREFIX}${Date.now()}`;
                    localStorage.setItem(key, snapshot);

                    const rawIndex = localStorage.getItem(this.BACKUP_INDEX_KEY);
                    const keys = Array.isArray(JSON.parse(rawIndex || '[]')) ? JSON.parse(rawIndex || '[]') : [];
                    keys.unshift(key);
                    const keep = keys.slice(0, this.MAX_BACKUPS);
                    localStorage.setItem(this.BACKUP_INDEX_KEY, JSON.stringify(keep));

                    keys.slice(this.MAX_BACKUPS).forEach(oldKey => {
                        localStorage.removeItem(oldKey);
                    });
                    return key;
                } catch (e) {
                    console.error('ÂàõÂª∫Â§á‰ªΩÂ§±Ë¥•:', e);
                    return null;
                }
            },

            restoreBackup(backupKey) {
                if (!backupKey) return false;
                try {
                    const snapshot = localStorage.getItem(backupKey);
                    if (!snapshot) return false;
                    localStorage.setItem(this.STORAGE_KEY, snapshot);
                    return true;
                } catch (e) {
                    console.error('ÊÅ¢Â§çÂ§á‰ªΩÂ§±Ë¥•:', e);
                    return false;
                }
            },

            resetRecords() {
                const data = this.load();
                const today = getLocalDateString(new Date());
                const assignment = this.createAssignment(today, 1);
                data.assignments = [assignment];
                data.records = { [assignment.id]: {} };
                this.save(data);
            }
        };

        // ============ Áä∂ÊÄÅÁÆ°ÁêÜ ============
        const AppState = {
            data: DataManager.load(),
            currentDate: getLocalDateString(new Date()),
            currentAssignmentId: null,
            selectedStudent: null,
            bulkMode: false,
            bulkSelectedIds: new Set(),

            init() {
                this.applySettings();
                this.ensureAssignmentForDate(this.currentDate);
            },

            applySettings() {
                const { settings } = this.data;
                document.body.classList.toggle('high-contrast', settings.highContrast);
                document.body.classList.toggle('no-animation', settings.noAnimation);
            },

            getAssignmentsForDate(dateStr) {
                return this.data.assignments
                    .filter(a => a.date === dateStr)
                    .sort((a, b) => b.order - a.order);
            },

            getSortedAssignments() {
                return [...this.data.assignments].sort((a, b) => {
                    if (a.date === b.date) {
                        return b.order - a.order;
                    }
                    return a.date < b.date ? 1 : -1;
                });
            },

            getCurrentAssignment() {
                return this.data.assignments.find(a => a.id === this.currentAssignmentId) || null;
            },

            ensureAssignmentForDate(dateStr) {
                const assignments = this.getAssignmentsForDate(dateStr);
                if (assignments.length === 0) {
                    const newAssignment = this.createAssignmentForDate(dateStr);
                    this.currentAssignmentId = newAssignment.id;
                    return newAssignment;
                }
                this.currentAssignmentId = assignments[0].id;
                return assignments[0];
            },

            createAssignmentForDate(dateStr) {
                const sameDate = this.data.assignments.filter(a => a.date === dateStr);
                const maxOrder = sameDate.length > 0 ? Math.max(...sameDate.map(a => a.order || 0)) : 0;
                const newAssignment = DataManager.createAssignment(dateStr, maxOrder + 1);
                this.data.assignments.push(newAssignment);
                this.data.records[newAssignment.id] = {};
                this.currentAssignmentId = newAssignment.id;
                DataManager.save(this.data);
                return newAssignment;
            },

            setCurrentAssignment(id) {
                const assignment = this.data.assignments.find(a => a.id === id);
                if (!assignment) return;
                this.currentAssignmentId = id;
                this.currentDate = assignment.date;
                this.clearBulkSelection();
            },

            renameCurrentAssignment(name) {
                const assignment = this.getCurrentAssignment();
                if (!assignment) return;
                assignment.name = name;
                DataManager.save(this.data);
            },

            getStudentRecord(studentId) {
                const assignmentId = this.currentAssignmentId;
                if (!assignmentId) {
                    return { status: 'pending', score: null };
                }
                const assignmentRecords = this.data.records[assignmentId] || {};
                return assignmentRecords[studentId] || { status: 'pending', score: null };
            },

            setStudentRecord(studentId, record) {
                const assignmentId = this.currentAssignmentId;
                if (!assignmentId) {
                    return false;
                }
                if (!this.data.records[assignmentId]) {
                    this.data.records[assignmentId] = {};
                }
                this.data.records[assignmentId][studentId] = record;
                DataManager.save(this.data);
                return true;
            },

            clearStudentRecord(studentId) {
                const assignmentId = this.currentAssignmentId;
                if (!assignmentId) return;
                if (this.data.records[assignmentId]) {
                    delete this.data.records[assignmentId][studentId];
                    DataManager.save(this.data);
                }
            },

            setBulkMode(enabled) {
                this.bulkMode = !!enabled;
                if (!this.bulkMode) {
                    this.clearBulkSelection();
                }
            },

            toggleBulkSelection(studentId) {
                if (this.bulkSelectedIds.has(studentId)) {
                    this.bulkSelectedIds.delete(studentId);
                } else {
                    this.bulkSelectedIds.add(studentId);
                }
            },

            clearBulkSelection() {
                this.bulkSelectedIds.clear();
            },

            selectAllStudents() {
                this.bulkSelectedIds = new Set(this.data.students.map(s => s.id));
            },

            isAllSelected() {
                const total = this.data.students.length;
                return total > 0 && this.bulkSelectedIds.size === total;
            },

            getSelectedIds() {
                return Array.from(this.bulkSelectedIds);
            },

            getStats() {
                const students = this.data.students;
                const assignmentId = this.currentAssignmentId;
                const assignmentRecords = this.data.records[assignmentId] || {};
                
                let submitted = 0, late = 0, missing = 0, totalScore = 0, scoredCount = 0;
                
                students.forEach(s => {
                    const r = assignmentRecords[s.id] || {};
                    if (r.status === 'submitted') submitted++;
                    else if (r.status === 'late') late++;
                    else if (r.status === 'missing') missing++;
                    
                    if (r.score !== null && r.score !== undefined) {
                        totalScore += r.score;
                        scoredCount++;
                    }
                });

                const total = students.length;
                const rate = total > 0 ? Math.round((submitted / total) * 100) : 0;

                return {
                    total,
                    submitted,
                    late,
                    missing,
                    pending: total - submitted - late - missing,
                    rate,
                    avgScore: scoredCount > 0 ? (totalScore / scoredCount).toFixed(1) : '-'
                };
            },

            getHistoryStats(count) {
                const limit = Math.max(1, count || this.data.settings.historyCount || 7);
                const assignments = this.getSortedAssignments().slice(0, limit);
                const total = this.data.students.length;
                return assignments.map(assignment => {
                    const records = this.data.records[assignment.id] || {};
                    const submitted = Object.values(records).filter(r => r.status === 'submitted').length;
                    const rate = total > 0 ? Math.round((submitted / total) * 100) : 0;
                    return { assignment, rate };
                });
            },

            markPendingAsMissingForCurrentAssignment() {
                const assignmentId = this.currentAssignmentId;
                if (!assignmentId) return -1;
                if (!this.data.records[assignmentId]) {
                    this.data.records[assignmentId] = {};
                }
                const assignmentRecords = this.data.records[assignmentId];
                let changed = 0;

                this.data.students.forEach(student => {
                    const record = assignmentRecords[student.id];
                    if (!record || !record.status || record.status === 'pending') {
                        assignmentRecords[student.id] = { status: 'missing', score: null };
                        changed++;
                    }
                });

                DataManager.save(this.data);
                return changed;
            }
        };

        // ============ UI Ê∏≤Êüì ============
        const UI = {
            clearElement(el) {
                if (!el) return;
                while (el.firstChild) {
                    el.removeChild(el.firstChild);
                }
            },

            renderGrid() {
                const grid = document.getElementById('studentGrid');
                const tip = document.getElementById('noAssignmentTip');
                const { students, settings } = AppState.data;
                const showFullname = settings.showFullname || false;
                
                const hasAssignment = !!AppState.currentAssignmentId;
                if (!hasAssignment && AppState.bulkMode) {
                    AppState.setBulkMode(false);
                }
                grid.className = `student-grid ${showFullname ? 'fullname' : ''} ${hasAssignment ? '' : 'disabled'}`;
                if (tip) {
                    tip.classList.toggle('show', !hasAssignment);
                }

                this.clearElement(grid);
                const fragment = document.createDocumentFragment();
                students.forEach(student => {
                    const record = AppState.getStudentRecord(student.id);
                    const statusClass = record.status === 'submitted' ? 'submitted' : 
                                       record.status === 'late' ? 'late' : 
                                       record.status === 'missing' ? 'missing' : '';
                    const selectedClass = AppState.bulkMode && AppState.bulkSelectedIds.has(student.id) ? 'selected' : '';

                    const card = document.createElement('div');
                    card.className = `student-card ${statusClass} ${selectedClass}`.trim();
                    card.dataset.id = student.id;

                    if (showFullname) {
                        const avatar = document.createElement('div');
                        avatar.className = 'fullname-avatar';
                        avatar.textContent = (student.name && student.name[0]) ? student.name[0] : '?';

                        const info = document.createElement('div');
                        info.className = 'fullname-info';

                        const nameEl = document.createElement('div');
                        nameEl.className = 'fullname-name';
                        nameEl.textContent = student.name || '';

                        const idEl = document.createElement('div');
                        idEl.className = 'fullname-id';
                        idEl.textContent = `${student.id}Âè∑`;

                        info.appendChild(nameEl);
                        info.appendChild(idEl);
                        card.appendChild(avatar);
                        card.appendChild(info);

                        if (record.score !== null && record.score !== undefined) {
                            const scoreEl = document.createElement('div');
                            scoreEl.className = 'fullname-score';
                            scoreEl.textContent = String(record.score);
                            card.appendChild(scoreEl);
                        }
                    } else {
                        const avatar = document.createElement('div');
                        avatar.className = 'compact-avatar';
                        avatar.textContent = (student.name && student.name[0]) ? student.name[0] : '?';

                        const idEl = document.createElement('div');
                        idEl.className = 'compact-id';
                        idEl.textContent = student.id || '';

                        card.appendChild(avatar);
                        card.appendChild(idEl);

                        if (record.score !== null && record.score !== undefined) {
                            const scoreEl = document.createElement('div');
                            scoreEl.className = 'compact-score';
                            scoreEl.textContent = String(record.score);
                            card.appendChild(scoreEl);
                        }
                    }

                    fragment.appendChild(card);
                });
                grid.appendChild(fragment);

                this.updateProgress();
                this.updateBulkBar();
            },

            updateProgress() {
                const stats = AppState.getStats();
                const progressBar = document.getElementById('progressBar');
                
                progressBar.style.width = stats.rate + '%';
                const submittedEl = document.getElementById('headerSubmittedValue');
                if (submittedEl) {
                    submittedEl.textContent = stats.submitted;
                }
            },

            updateBulkBar() {
                const bulkBar = document.getElementById('bulkBar');
                const bulkToggle = document.getElementById('toggleBulk');
                const countEl = document.getElementById('bulkCount');
                const selectAllBtn = document.getElementById('bulkSelectAll');
                const clearBtn = document.getElementById('bulkClear');
                const hasAssignment = !!AppState.currentAssignmentId;
                const enabled = AppState.bulkMode && hasAssignment;

                if (bulkBar) bulkBar.classList.toggle('show', enabled);
                document.body.classList.toggle('bulk-mode', enabled);
                if (bulkToggle) bulkToggle.classList.toggle('active', enabled);

                const count = AppState.bulkSelectedIds.size;
                if (countEl) countEl.textContent = `Â∑≤ÈÄâ ${count}`;
                if (selectAllBtn) {
                    selectAllBtn.textContent = AppState.isAllSelected() ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ';
                    selectAllBtn.disabled = AppState.data.students.length === 0;
                }
                if (clearBtn) clearBtn.disabled = count === 0;

                document.querySelectorAll('[data-bulk-status]').forEach(btn => {
                    btn.disabled = count === 0;
                });
            },

            updateAssignmentMeta() {
                const metaEl = document.getElementById('assignmentMeta');
                if (!metaEl) return;
                const assignment = AppState.getCurrentAssignment();
                if (!assignment) {
                    metaEl.textContent = 'ÂΩìÂâçÊó•ÊúüÊöÇÊó†‰Ωú‰∏ö';
                    return;
                }
                const assignmentsForDate = AppState.getAssignmentsForDate(assignment.date);
                metaEl.textContent = `${assignment.date} ¬∑ Á¨¨${assignment.order}È°π/ÂÖ±${assignmentsForDate.length}È°π`;
            },

            setExportMode(mode) {
                const exportText = document.getElementById('exportText');
                const jsonBtn = document.getElementById('exportJsonBtn');
                const csvBtn = document.getElementById('exportCsvBtn');
                if (!exportText || !jsonBtn || !csvBtn) return;
                if (mode === 'csv') {
                    exportText.value = DataManager.exportCSV(AppState.currentAssignmentId);
                } else {
                    exportText.value = DataManager.export();
                }
                jsonBtn.classList.toggle('btn-primary', mode !== 'csv');
                csvBtn.classList.toggle('btn-primary', mode === 'csv');
            },

            renderAssignmentList() {
                const list = document.getElementById('assignmentList');
                if (!list) return;
                const assignments = AppState.getAssignmentsForDate(AppState.currentDate);
                this.clearElement(list);
                if (assignments.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'settings-desc';
                    empty.textContent = 'ËØ•Êó•ÊúüÊöÇÊó†‰Ωú‰∏öÔºåÁÇπÂáª‰∏äÊñπÊåâÈíÆÊñ∞Âª∫';
                    list.appendChild(empty);
                    return;
                }
                const fragment = document.createDocumentFragment();
                assignments.forEach(assignment => {
                    const isActive = assignment.id === AppState.currentAssignmentId;

                    const item = document.createElement('div');
                    item.className = `assignment-item ${isActive ? 'active' : ''}`.trim();
                    item.dataset.id = assignment.id;
                    item.setAttribute('role', 'button');
                    item.tabIndex = 0;
                    item.setAttribute('aria-current', isActive ? 'true' : 'false');

                    const info = document.createElement('div');
                    info.className = 'assignment-item-info';

                    const nameEl = document.createElement('div');
                    nameEl.className = 'assignment-item-name';
                    nameEl.textContent = assignment.name || '';
                    nameEl.title = assignment.name || '';

                    const metaEl = document.createElement('div');
                    metaEl.className = 'assignment-item-meta';
                    metaEl.textContent = `${assignment.date} ¬∑ Á¨¨${assignment.order}È°π`;

                    const action = document.createElement('span');
                    action.style.fontSize = '14px';
                    action.style.color = 'var(--text-secondary)';
                    action.textContent = 'ÂàáÊç¢';

                    info.appendChild(nameEl);
                    info.appendChild(metaEl);
                    item.appendChild(info);
                    item.appendChild(action);
                    fragment.appendChild(item);
                });
                list.appendChild(fragment);
            },

            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            },

            showScoreModal(student) {
                AppState.selectedStudent = student;
                const record = AppState.getStudentRecord(student.id);
                
                document.getElementById('modalStudentName').textContent = student.name;
                document.getElementById('modalStudentId').textContent = student.id + 'Âè∑';
                document.querySelector('.student-info-avatar').textContent = student.name[0];
                
                // Ê∏≤ÊüìÁä∂ÊÄÅÊåâÈíÆ
                document.querySelectorAll('.status-btn').forEach(btn => {
                    // pending Áä∂ÊÄÅË°®Á§∫Êú™ÁôªËÆ∞ÔºåÂΩì record.status ‰∏∫ 'pending' Êàñ‰∏çÂ≠òÂú®Êó∂ÈÄâ‰∏≠
                    const isPending = btn.dataset.status === 'pending';
                    const isActive = isPending 
                        ? (!record.status || record.status === 'pending')
                        : btn.dataset.status === record.status;
                    btn.classList.toggle('active', isActive);
                });
                
                // ËÆæÁΩÆÂàÜÊï∞ËæìÂÖ•Ê°Ü
                const scoreInput = document.getElementById('scoreInput');
                if (scoreInput) {
                    scoreInput.value = record.score !== null && record.score !== undefined ? record.score : '';
                }
                
                document.getElementById('scoreModal').classList.add('show');
            },

            hideScoreModal() {
                document.getElementById('scoreModal').classList.remove('show');
                AppState.selectedStudent = null;
            },

            updateStats() {
                const stats = AppState.getStats();
                document.getElementById('statTotal').textContent = stats.total;
                document.getElementById('statSubmitted').textContent = stats.submitted;
                document.getElementById('statRate').textContent = stats.rate + '%';
                document.getElementById('statAvg').textContent = stats.avgScore;

                const currentAssignment = AppState.getCurrentAssignment();
                const assignmentLabel = currentAssignment ? currentAssignment.name : '-';
                document.getElementById('statsAssignmentName').textContent = `ÂΩìÂâç‰Ωú‰∏öÔºö${assignmentLabel}`;

                const historyCount = AppState.data.settings.historyCount || 7;
                const historyInput = document.getElementById('historyRangeInput');
                if (historyInput) historyInput.value = historyCount;

                const list = document.getElementById('statsStudentList');
                if (list) {
                    const students = AppState.data.students;
                    const assignments = AppState.getSortedAssignments().slice(0, historyCount);
                    this.clearElement(list);
                    const fragment = document.createDocumentFragment();

                    students.forEach(student => {
                        const item = document.createElement('div');
                        item.className = 'stats-list-item';

                        const info = document.createElement('div');
                        const nameEl = document.createElement('div');
                        nameEl.className = 'stats-list-name';
                        nameEl.textContent = student.name || '';

                        const idEl = document.createElement('div');
                        idEl.className = 'stats-list-sub';
                        idEl.textContent = `${student.id}Âè∑`;

                        info.appendChild(nameEl);
                        info.appendChild(idEl);

                        const dotsEl = document.createElement('div');
                        dotsEl.className = 'stats-dots';

                        assignments.forEach(assignment => {
                            const records = AppState.data.records[assignment.id] || {};
                            const record = records[student.id] || { status: 'pending' };
                            const status = record.status || 'pending';
                            const dot = document.createElement('span');
                            dot.className = `stats-dot ${status}`;
                            dot.dataset.title = assignment.name || '';
                            dotsEl.appendChild(dot);
                        });

                        item.appendChild(info);
                        item.appendChild(dotsEl);
                        fragment.appendChild(item);
                    });
                    list.appendChild(fragment);
                }

                // Ê∏≤ÊüìÂéÜÂè≤ÂõæË°®
                const history = AppState.getHistoryStats(historyCount);
                const chart = document.getElementById('historyChart');
                if (!chart) return;
                this.clearElement(chart);
                const chartFragment = document.createDocumentFragment();
                history.forEach(h => {
                    const column = document.createElement('div');
                    column.style.cssText = 'display: flex; flex-direction: column; align-items: center; flex: 1;';

                    const bar = document.createElement('div');
                    bar.style.height = `${h.rate * 1.5}px`;
                    bar.style.width = '30px';
                    bar.style.background = 'var(--primary)';
                    bar.style.borderRadius = '4px 4px 0 0';
                    bar.style.opacity = '0.8';

                    const name = document.createElement('div');
                    name.style.cssText = 'font-size: 10px; margin-top: 4px; color: var(--text-secondary);';
                    const assignmentName = h.assignment.name || '';
                    name.textContent = assignmentName.length > 6 ? `${assignmentName.slice(0, 6)}‚Ä¶` : assignmentName;

                    const date = document.createElement('div');
                    date.style.cssText = 'font-size: 9px; color: var(--text-secondary);';
                    date.textContent = (h.assignment.date || '').slice(5).replace('-', '/');

                    const rate = document.createElement('div');
                    rate.style.cssText = 'font-size: 11px; font-weight: 600;';
                    rate.textContent = `${h.rate}%`;

                    column.appendChild(bar);
                    column.appendChild(name);
                    column.appendChild(date);
                    column.appendChild(rate);
                    chartFragment.appendChild(column);
                });
                chart.appendChild(chartFragment);
            }
        };

        // ============ ‰∫ã‰ª∂Â§ÑÁêÜ ============
        const Events = {
            init() {
                let lastBackTime = 0;
                let allowNativeBackUntil = 0;
                const BACK_EXIT_INTERVAL = 1500;
                const BACK_RELEASE_WINDOW = 800;
                let backTrapArmed = false;
                const byId = (id) => document.getElementById(id);
                const on = (el, eventName, handler, options) => {
                    if (!el) return false;
                    el.addEventListener(eventName, handler, options);
                    return true;
                };
                const onId = (id, eventName, handler, options) => on(byId(id), eventName, handler, options);
                const bindKeyboardClick = (el) => {
                    if (!el) return;
                    on(el, 'keydown', (e) => {
                        if (e.key !== 'Enter' && e.key !== ' ') return;
                        e.preventDefault();
                        el.click();
                    });
                };
                document.querySelectorAll('[data-keyboard-click]').forEach(bindKeyboardClick);

                const closeAllPanels = () => {
                    let closed = false;
                    const panels = ['menuPanel', 'statsPanel', 'dataPanel', 'calendarPanel'];
                    panels.forEach(id => {
                        const panel = document.getElementById(id);
                        if (panel && panel.classList.contains('show')) {
                            panel.classList.remove('show');
                            closed = true;
                        }
                    });
                    const scoreModal = byId('scoreModal');
                    if (scoreModal && scoreModal.classList.contains('show')) {
                        closed = true;
                    }
                    UI.hideScoreModal();
                    return closed;
                };
                const ensureCurrentAssignment = () => {
                    if (AppState.currentAssignmentId) return true;
                    UI.showToast(NO_ASSIGNMENT_MSG);
                    return false;
                };
                const parseScore = (rawValue) => {
                    const value = String(rawValue || '').trim();
                    const score = value === '' ? null : parseFloat(value);
                    if (score !== null && (isNaN(score) || score < 0 || score > 100)) {
                        return { ok: false, score: null };
                    }
                    return { ok: true, score };
                };
                const saveSubmittedForSelected = (rawValue, closeModal = true) => {
                    if (!AppState.selectedStudent) return false;
                    if (!ensureCurrentAssignment()) return false;
                    const parsed = parseScore(rawValue);
                    if (!parsed.ok) {
                        UI.showToast(SCORE_RANGE_MSG);
                        return false;
                    }
                    const ok = AppState.setStudentRecord(AppState.selectedStudent.id, { status: 'submitted', score: parsed.score });
                    if (!ok) {
                        UI.showToast(NO_ASSIGNMENT_MSG);
                        return false;
                    }
                    UI.renderGrid();
                    UI.showToast(parsed.score !== null ? `Â∑≤ÁôªËÆ∞: Â∑≤‰∫§ ${parsed.score}ÂàÜ` : 'Â∑≤ÁôªËÆ∞: Â∑≤‰∫§');
                    if (closeModal) UI.hideScoreModal();
                    return true;
                };
                const toggleSetting = (key, afterToggle) => {
                    AppState.data.settings[key] = !AppState.data.settings[key];
                    DataManager.save(AppState.data);
                    if (afterToggle) afterToggle();
                    this.updateSwitches();
                };
                const handleEscapeAction = () => {
                    let handled = false;
                    if (AppState.bulkMode) {
                        AppState.setBulkMode(false);
                        UI.renderGrid();
                        handled = true;
                    }
                    if (closeAllPanels()) {
                        handled = true;
                    }
                    return handled;
                };
                const armBackTrap = () => {
                    if (backTrapArmed) return;
                    history.pushState({ __psaBackTrap: true, t: Date.now() }, '');
                    backTrapArmed = true;
                };
                const rearmBackTrap = () => {
                    backTrapArmed = false;
                    // Âú®Âêå‰∏Ä‰∫ã‰ª∂Âæ™ÁéØÁªìÊùüÂêéË°•ÂõûÊã¶Êà™Êù°ÁõÆÔºåÂÖºÂÆπÈÉ®ÂàÜ Android ÊµèËßàÂô®Êó∂Â∫è
                    setTimeout(() => {
                        armBackTrap();
                    }, 0);
                };

                // Android ËøîÂõûÈîÆÔºö‰ºòÂÖàÊåâ ESC ÂÖ≥Èó≠‰∫§‰∫íÂ±ÇÔºõ‰∏ªÁïåÈù¢ÂèåÂáªËøîÂõûÊâçÈÄÄÂá∫
                armBackTrap();
                window.addEventListener('pageshow', () => {
                    allowNativeBackUntil = 0;
                    armBackTrap();
                });
                window.addEventListener('popstate', () => {
                    // Êú¨Ê¨° back Â∑≤Ê∂àË¥πÊéâ‰∏ÄÂ±Ç trapÔºåÈúÄË¶ÅÊåâÂàÜÊîØÂÜ≥ÂÆöÊòØÂê¶Ë°•Âõû
                    backTrapArmed = false;
                    const now = Date.now();
                    if (now < allowNativeBackUntil) {
                        allowNativeBackUntil = 0;
                        return;
                    }

                    const handled = handleEscapeAction();
                    if (handled) {
                        lastBackTime = 0;
                        rearmBackTrap();
                        return;
                    }

                    if (now - lastBackTime < BACK_EXIT_INTERVAL) {
                        allowNativeBackUntil = now + BACK_RELEASE_WINDOW;
                        setTimeout(() => {
                            allowNativeBackUntil = 0;
                        }, BACK_RELEASE_WINDOW + 100);
                        history.back();
                        return;
                    }

                    lastBackTime = now;
                    UI.showToast('ÂÜçÊåâ‰∏ÄÊ¨°ËøîÂõûÈÄÄÂá∫');
                    rearmBackTrap();
                });

                // Êó•ÂéÜÈù¢Êùø
                const calendarPanel = byId('calendarPanel');
                const dateTrigger = byId('dateTrigger');
                const calendarDays = byId('calendarDays');
                const calendarMonth = byId('calendarMonth');
                const assignmentNameInput = byId('assignmentNameInput');
                const assignmentList = byId('assignmentList');
                const createAssignmentBtn = byId('createAssignmentBtn');
                const historyRangeInput = byId('historyRangeInput');
                const applyHistoryRange = byId('applyHistoryRange');
                const studentGrid = byId('studentGrid');
                let calendarCurrentDate = new Date(AppState.currentDate);

                function formatDateLabel(date) {
                    const today = new Date();
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${y}-${m}-${d}`;

                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowStr = `${tomorrow.getFullYear()}-${String(tomorrow.getMonth() + 1).padStart(2, '0')}-${String(tomorrow.getDate()).padStart(2, '0')}`;

                    let label = `${y}-${m}-${d}`;
                    if (dateStr === todayStr) {
                        label += ' ‰ªäÂ§©';
                    } else if (dateStr === yesterdayStr) {
                        label += ' Êò®Â§©';
                    } else if (dateStr === tomorrowStr) {
                        label += ' ÊòéÂ§©';
                    } else {
                        label += ` ${m}/${d}`;
                    }
                    return label;
                }

                function updateDateTrigger() {
                    const date = new Date(AppState.currentDate);
                    const assignment = AppState.getCurrentAssignment();
                    const name = assignment ? assignment.name : 'Êú™ÂàõÂª∫‰Ωú‰∏ö';
                    document.getElementById('dateTriggerPrimary').textContent = name;
                    document.getElementById('dateTriggerSecondary').textContent = formatDateLabel(date);
                }

                function renderCalendar() {
                    if (!calendarMonth || !calendarDays) return;
                    const year = calendarCurrentDate.getFullYear();
                    const month = calendarCurrentDate.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const startDate = new Date(firstDay);
                    startDate.setDate(startDate.getDate() - firstDay.getDay());

                    calendarMonth.textContent = `${year}Âπ¥${month + 1}Êúà`;
                    calendarDays.innerHTML = '';

                    const today = getLocalDateString(new Date());
                    const selected = AppState.currentDate;

                    for (let i = 0; i < 42; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);

                        const dateStr = getLocalDateString(date);
                        const dayEl = document.createElement('div');
                        dayEl.className = 'calendar-day';
                        dayEl.textContent = date.getDate();

                        if (date.getMonth() !== month) {
                            dayEl.classList.add('other-month');
                        }
                        if (dateStr === today) {
                            dayEl.classList.add('today');
                            const marker = document.createElement('span');
                            marker.className = 'day-marker';
                            dayEl.appendChild(marker);
                        }
                        if (dateStr === selected) {
                            dayEl.classList.add('selected');
                            const marker = dayEl.querySelector('.day-marker');
                            if (marker) marker.remove();
                        }

                        dayEl.addEventListener('click', () => {
                            AppState.currentDate = dateStr;
                            const assignments = AppState.getAssignmentsForDate(dateStr);
                            AppState.currentAssignmentId = assignments.length > 0 ? assignments[0].id : null;
                            updateDateTrigger();
                            UI.renderGrid();
                            UI.renderAssignmentList();
                            UI.updateAssignmentMeta();
                            if (assignmentNameInput) {
                                const current = AppState.getCurrentAssignment();
                                assignmentNameInput.value = current ? current.name : '';
                            }
                            calendarPanel.classList.remove('show');
                        });

                        calendarDays.appendChild(dayEl);
                    }
                }

                function openCalendarPanel() {
                    if (!calendarPanel) return;
                    calendarCurrentDate = new Date(AppState.currentDate);
                    renderCalendar();
                    const current = AppState.getCurrentAssignment();
                    if (assignmentNameInput) {
                        assignmentNameInput.value = current ? current.name : '';
                    }
                    UI.renderAssignmentList();
                    UI.updateAssignmentMeta();
                    calendarPanel.classList.add('show');
                }

                on(dateTrigger, 'click', openCalendarPanel);

                on(calendarPanel, 'click', (e) => {
                    if (e.target === calendarPanel) {
                        calendarPanel.classList.remove('show');
                    }
                });

                onId('calendarPrevMonth', 'click', () => {
                    calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1);
                    renderCalendar();
                });

                onId('calendarNextMonth', 'click', () => {
                    calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1);
                    renderCalendar();
                });

                onId('calendarClose', 'click', () => {
                    if (!calendarPanel) return;
                    calendarPanel.classList.remove('show');
                });

                updateDateTrigger();

                const handleCreateAssignment = () => {
                    const newAssignment = AppState.createAssignmentForDate(AppState.currentDate);
                    updateDateTrigger();
                    UI.renderGrid();
                    UI.renderAssignmentList();
                    UI.updateAssignmentMeta();
                    if (assignmentNameInput) {
                        assignmentNameInput.value = newAssignment.name;
                    }
                    UI.showToast(`Â∑≤ÂàõÂª∫: ${newAssignment.name}`);
                };

                on(createAssignmentBtn, 'click', handleCreateAssignment);

                onId('saveAssignmentName', 'click', () => {
                    if (!assignmentNameInput) return;
                    const name = assignmentNameInput.value.trim();
                    if (!name) {
                        UI.showToast('‰Ωú‰∏öÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
                        return;
                    }
                    AppState.renameCurrentAssignment(name);
                    updateDateTrigger();
                    UI.renderAssignmentList();
                    UI.updateAssignmentMeta();
                    UI.showToast('Â∑≤Êõ¥Êñ∞‰Ωú‰∏öÂêçÁß∞');
                });

                on(assignmentNameInput, 'keydown', (e) => {
                    if (e.key !== 'Enter') return;
                    e.preventDefault();
                    const saveBtn = byId('saveAssignmentName');
                    if (saveBtn) saveBtn.click();
                });

                on(assignmentList, 'click', (e) => {
                    const item = e.target.closest('.assignment-item');
                    if (!item) return;
                    AppState.setCurrentAssignment(item.dataset.id);
                    updateDateTrigger();
                    UI.renderGrid();
                    UI.renderAssignmentList();
                    UI.updateAssignmentMeta();
                    if (assignmentNameInput) {
                        const current = AppState.getCurrentAssignment();
                        assignmentNameInput.value = current ? current.name : '';
                    }
                });
                on(assignmentList, 'keydown', (e) => {
                    if (e.key !== 'Enter' && e.key !== ' ') return;
                    const item = e.target.closest('.assignment-item');
                    if (!item) return;
                    e.preventDefault();
                    item.click();
                });

                // Â∑¶ÊåâÈíÆÔºöÂàáÊç¢ÂÆåÊï¥ÂßìÂêçÊòæÁ§∫
                onId('toggleViewMode', 'click', () => {
                    toggleSetting('showFullname', () => {
                        UI.renderGrid();
                    });
                });

                // ÊâπÈáèÈÄâÊã©
                onId('toggleBulk', 'click', () => {
                    if (!ensureCurrentAssignment()) return;
                    AppState.setBulkMode(!AppState.bulkMode);
                    UI.renderGrid();
                });

                onId('bulkSelectAll', 'click', () => {
                    if (!AppState.bulkMode) return;
                    if (AppState.isAllSelected()) {
                        AppState.clearBulkSelection();
                    } else {
                        AppState.selectAllStudents();
                    }
                    UI.renderGrid();
                });

                onId('bulkClear', 'click', () => {
                    if (!AppState.bulkMode) return;
                    AppState.clearBulkSelection();
                    UI.renderGrid();
                });

                document.querySelectorAll('[data-bulk-status]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (!AppState.bulkMode) return;
                        if (!ensureCurrentAssignment()) return;
                        const status = btn.dataset.bulkStatus;
                        const selectedIds = AppState.getSelectedIds();
                        if (selectedIds.length === 0) return;

                        selectedIds.forEach(studentId => {
                            if (status === 'pending') {
                                AppState.clearStudentRecord(studentId);
                                return;
                            }
                            const record = AppState.getStudentRecord(studentId);
                            AppState.setStudentRecord(studentId, { ...record, status });
                        });

                        const statusText = status === 'pending' ? 'ÂèñÊ∂àÁôªËÆ∞' : (STATUS_TEXT_MAP[status] || status);
                        UI.showToast(`Â∑≤ÊâπÈáèÊõ¥Êñ∞: ${statusText} (${selectedIds.length}‰∫∫)`);
                        AppState.clearBulkSelection();
                        UI.renderGrid();
                    });
                });

                // Â≠¶ÁîüÂç°Áâá‰∫§‰∫í - ÁÇπÂáªÂàáÊç¢Áä∂ÊÄÅÔºåÈïøÊåâÊâìÂºÄËØÑÂàÜ
                let pressCardId = null;
                let isLongPress = false;
                let longPressTimer = null;
                let touchStartY = 0;
                let touchStartX = 0;
                const LONG_PRESS_DURATION = 500;
                const SCROLL_THRESHOLD = 8;

                if (studentGrid) {
                    // Áªü‰∏ÄÂ§ÑÁêÜÊâÄÊúâËæìÂÖ•ËÆæÂ§áÔºàÈº†Ê†á„ÄÅËß¶Êë∏„ÄÅËß¶ÊéßÁ¨îÔºâ
                    studentGrid.addEventListener('pointerdown', (e) => {
                        const card = e.target.closest('.student-card');
                        if (!card) return;
                        if (e.pointerType === 'mouse' && e.button !== 0) return;
                        if (!ensureCurrentAssignment()) return;
                        pressCardId = card.dataset.id;
                        isLongPress = false;
                        
                        if (e.pointerType === 'touch') {
                            touchStartY = e.clientY;
                            touchStartX = e.clientX;
                        }

                        card.setPointerCapture(e.pointerId);

                        if (AppState.bulkMode) {
                            return;
                        }

                        // ÂêØÂä®ÈïøÊåâÂÆöÊó∂Âô®ÔºåÂà∞ËææÊó∂Èó¥Ëá™Âä®ÂºπÂá∫ËØÑÂàÜÂºπÁ™ó
                        longPressTimer = setTimeout(() => {
                            isLongPress = true;
                            const student = AppState.data.students.find(s => s.id === pressCardId);
                            if (student) {
                                UI.showScoreModal(student);
                            }
                        }, LONG_PRESS_DURATION);
                    });

                    studentGrid.addEventListener('pointerup', (e) => {
                        const card = e.target.closest('.student-card');
                        
                        // Ê∏ÖÈô§ÈïøÊåâÂÆöÊó∂Âô®
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                        
                        // Â¶ÇÊûúÂ∑≤ÁªèËß¶Âèë‰∫ÜÈïøÊåâÔºå‰∏çÊâßË°åÁÇπÂáªÊìç‰Ωú
                        if (isLongPress) {
                            pressCardId = null;
                            return;
                        }
                        
                        if (!card || pressCardId !== card.dataset.id) {
                            pressCardId = null;
                            return;
                        }

                        if (AppState.bulkMode) {
                            AppState.toggleBulkSelection(pressCardId);
                            UI.renderGrid();
                            pressCardId = null;
                            return;
                        }

                        if (!ensureCurrentAssignment()) {
                            pressCardId = null;
                            return;
                        }

                        // Áü≠ÊåâÔºöÂàáÊç¢Áä∂ÊÄÅ
                        const student = AppState.data.students.find(s => s.id === pressCardId);
                        if (student) {
                            const record = AppState.getStudentRecord(pressCardId);
                            const newStatus = record.status === 'submitted' ? 'pending' : 'submitted';
                            const ok = AppState.setStudentRecord(pressCardId, { ...record, status: newStatus });
                            if (!ok) {
                                UI.showToast(NO_ASSIGNMENT_MSG);
                                pressCardId = null;
                                return;
                            }
                            UI.renderGrid();
                        }

                        pressCardId = null;
                    });

                    studentGrid.addEventListener('pointercancel', () => {
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                        pressCardId = null;
                    });

                    // Ëß¶Êë∏ËÆæÂ§á‰∏ìÁî®ÔºöÊ£ÄÊµãÊªëÂä®ÔºåÈòªÊ≠¢ÊªëÂä®Êó∂Ëß¶ÂèëÁÇπÂáª
                    studentGrid.addEventListener('touchmove', (e) => {
                        if (!pressCardId) return;
                        const touch = e.touches[0];
                        const deltaY = Math.abs(touch.clientY - touchStartY);
                        const deltaX = Math.abs(touch.clientX - touchStartX);
                        if (deltaY > SCROLL_THRESHOLD || deltaX > SCROLL_THRESHOLD) {
                            // ÊªëÂä®Êó∂ÂèñÊ∂àÈïøÊåâÂíåÁÇπÂáª
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                            pressCardId = null;
                        }
                    }, { passive: true });

                    // Ëß¶Êë∏ËÆæÂ§á‰∏ìÁî®ÔºöÈòªÊ≠¢ touchend ÂêéÊµèËßàÂô®ÂêàÊàêÁöÑ click ‰∫ã‰ª∂
                    studentGrid.addEventListener('touchend', (e) => {
                        if (pressCardId) {
                            e.preventDefault();
                        }
                        pressCardId = null;
                    });

                    // Èò≤Ê≠¢Âè≥ÈîÆËèúÂçïÂπ≤Êâ∞
                    studentGrid.addEventListener('contextmenu', (e) => {
                        if (e.target.closest('.student-card')) {
                            e.preventDefault();
                        }
                    });
                }

                // ËØÑÂàÜÂºπÁ™ó
                onId('closeModal', 'click', UI.hideScoreModal);
                onId('scoreModal', 'click', (e) => {
                    if (e.target.id === 'scoreModal') UI.hideScoreModal();
                });

                // Áä∂ÊÄÅÈÄâÊã© - ÁÇπÂáªÂêéËá™Âä®‰øùÂ≠òÂπ∂ÂÖ≥Èó≠ÂºπÁ™ó
                const scoreInput = document.getElementById('scoreInput');
                document.querySelectorAll('.status-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (!AppState.selectedStudent) return;
                        if (!ensureCurrentAssignment()) return;

                        const status = btn.dataset.status;
                        const studentId = AppState.selectedStudent.id;
                        const parsed = parseScore(scoreInput ? scoreInput.value : '');
                        if (!parsed.ok) {
                            UI.showToast(SCORE_RANGE_MSG);
                            return;
                        }

                        if (status === 'pending') {
                            AppState.clearStudentRecord(studentId);
                            UI.showToast('Â∑≤ÂèñÊ∂àÁôªËÆ∞');
                        } else {
                            const ok = AppState.setStudentRecord(studentId, { status, score: parsed.score });
                            if (!ok) {
                                UI.showToast(NO_ASSIGNMENT_MSG);
                                return;
                            }
                            const statusText = STATUS_TEXT_MAP[status] || status;
                            UI.showToast(parsed.score !== null ? `Â∑≤ÁôªËÆ∞: ${statusText} ${parsed.score}ÂàÜ` : `Â∑≤ÁôªËÆ∞: ${statusText}`);
                        }

                        UI.renderGrid();
                        UI.hideScoreModal();
                    });
                });

                if (scoreInput) {
                    // ÈôêÂà∂ËæìÂÖ•ËåÉÂõ¥ÔºàÁî®‰∫éÁ≥ªÁªüËæìÂÖ•Ê≥ïËæìÂÖ•ÁöÑÊÉÖÂÜµÔºâ
                    scoreInput.addEventListener('input', (e) => {
                        let value = e.target.value;

                        // Âè™ÂÖÅËÆ∏Êï∞Â≠óÂíåÂ∞èÊï∞ÁÇπ
                        value = value.replace(/[^0-9.]/g, '');

                        // Á°Æ‰øùÂè™Êúâ‰∏Ä‰∏™Â∞èÊï∞ÁÇπ
                        const parts = value.split('.');
                        if (parts.length > 2) {
                            value = parts[0] + '.' + parts.slice(1).join('');
                        }

                        // ÈôêÂà∂Â∞èÊï∞‰ΩçÊï∞‰∏∫2‰Ωç
                        if (parts.length === 2 && parts[1].length > 2) {
                            value = parseFloat(value).toFixed(2);
                        }

                        // ÈôêÂà∂ËåÉÂõ¥ 0-100
                        const numValue = parseFloat(value);
                        if (isNaN(numValue) || numValue > 100) {
                            value = '';
                        }

                        e.target.value = value;
                    });

                    // Ê∏ÖÁ©∫ÊåâÈíÆ‰∫ã‰ª∂
                    document.querySelectorAll('.score-clear-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            scoreInput.value = '';
                            scoreInput.focus();
                        });
                    });

                    // Êï∞Â≠óÈîÆÁõò‰∫ã‰ª∂Â§ÑÁêÜ
                    document.querySelectorAll('.numpad-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const action = btn.dataset.action;
                            let value = scoreInput.value || '';

                            if (action === 'num') {
                                const num = btn.textContent;
                                if (value.length < 6) {
                                    if (value === '0' && num !== '0') {
                                        value = num;
                                    } else if (value !== '0' || num === '.') {
                                        value += num;
                                    }
                                }
                            } else if (action === 'decimal') {
                                if (!value.includes('.')) {
                                    value += value === '' ? '0.' : '.';
                                }
                            } else if (action === 'backspace') {
                                value = value.slice(0, -1);
                            } else if (action === 'clear') {
                                value = '';
                            } else if (action === 'confirm') {
                                if (value !== '') {
                                    const num = parseFloat(value);
                                    if (num > 100) value = '100';
                                }
                                scoreInput.value = value;
                                saveSubmittedForSelected(scoreInput.value, true);
                                return;
                            }

                            scoreInput.value = value;
                        });
                    });

                    // ÂõûËΩ¶ÈîÆ - ÈªòËÆ§‰ª•"Â∑≤‰∫§"Áä∂ÊÄÅ‰øùÂ≠òÔºàÂÖºÂÆπWindowsÂíåAndroidÔºâ
                    scoreInput.addEventListener('keydown', (e) => {
                        if (e.key !== 'Enter' && e.keyCode !== 13) return;
                        e.preventDefault();
                        saveSubmittedForSelected(scoreInput.value, true);
                    });
                }

                // ‰∏ªËèúÂçï
                onId('menuBtn', 'click', () => {
                    this.updateSwitches();
                    const menuPanel = byId('menuPanel');
                    if (menuPanel) menuPanel.classList.add('show');
                });

                onId('closeMenu', 'click', () => {
                    const menuPanel = byId('menuPanel');
                    if (menuPanel) menuPanel.classList.remove('show');
                });

                onId('fullnameSwitch', 'click', (e) => {
                    toggleSetting('showFullname', () => {
                        UI.renderGrid();
                    });
                });

                onId('assignmentItem', 'click', () => {
                    const menuPanel = byId('menuPanel');
                    if (menuPanel) menuPanel.classList.remove('show');
                    openCalendarPanel();
                });

                onId('dataItem', 'click', () => {
                    const menuPanel = byId('menuPanel');
                    if (menuPanel) menuPanel.classList.remove('show');
                    UI.setExportMode('json');
                    const dataPanel = byId('dataPanel');
                    if (dataPanel) dataPanel.classList.add('show');
                });

                onId('statsItem', 'click', () => {
                    const menuPanel = byId('menuPanel');
                    if (menuPanel) menuPanel.classList.remove('show');
                    UI.updateStats();
                    const statsPanel = byId('statsPanel');
                    if (statsPanel) statsPanel.classList.add('show');
                });

                onId('markPendingMissingItem', 'click', () => {
                    const menuPanel = byId('menuPanel');
                    if (menuPanel) menuPanel.classList.remove('show');
                    if (!ensureCurrentAssignment()) return;
                    if (!confirm('Â∞ÜÂΩìÂâç‰Ωú‰∏öÊâÄÊúâÊú™ÁôªËÆ∞Â≠¶ÁîüÊ†áËÆ∞‰∏∫Êú™‰∫§Ôºü')) {
                        return;
                    }

                    const changed = AppState.markPendingAsMissingForCurrentAssignment();
                    if (changed < 0) {
                        UI.showToast(NO_ASSIGNMENT_MSG);
                        return;
                    }

                    UI.renderGrid();
                    const statsPanel = byId('statsPanel');
                    if (statsPanel && statsPanel.classList.contains('show')) {
                        UI.updateStats();
                    }
                    UI.showToast(changed === 0 ? 'Êó†ÈúÄÊõ¥Êñ∞ÔºåÂΩìÂâç‰Ωú‰∏öÊó†Êú™ÁôªËÆ∞' : `Â∑≤Êõ¥Êñ∞ ${changed} ‰∫∫‰∏∫Êú™‰∫§`);
                });

                // ÂºÄÂÖ≥
                onId('contrastSwitch', 'click', (e) => {
                    toggleSetting('highContrast', () => {
                        AppState.applySettings();
                    });
                });

                onId('animationSwitch', 'click', (e) => {
                    toggleSetting('noAnimation', () => {
                        AppState.applySettings();
                    });
                });

                // ÈáçÁΩÆÊï∞ÊçÆ
                onId('resetDataBtn', 'click', () => {
                    if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤Êï∞ÊçÆÂêóÔºüÂ≠¶ÁîüÂêçÂçïÂ∞Ü‰øùÁïô„ÄÇ')) {
                        DataManager.resetRecords();
                        AppState.data = DataManager.load();
                        AppState.currentDate = getLocalDateString(new Date());
                        const assignments = AppState.getAssignmentsForDate(AppState.currentDate);
                        AppState.currentAssignmentId = assignments.length > 0 ? assignments[0].id : null;
                        updateDateTrigger();
                        UI.renderGrid();
                        UI.showToast('Êï∞ÊçÆÂ∑≤ÈáçÁΩÆ');
                    }
                });

                // ÁªüËÆ°Èù¢Êùø
                onId('closeStats', 'click', () => {
                    const statsPanel = byId('statsPanel');
                    if (statsPanel) statsPanel.classList.remove('show');
                });

                onId('statsCollapse', 'click', () => {
                    const header = byId('statsCollapse');
                    const body = byId('statsCollapseBody');
                    if (!header || !body) return;
                    const isCollapsed = body.classList.toggle('collapsed');
                    header.classList.toggle('collapsed', isCollapsed);
                    header.setAttribute('aria-expanded', String(!isCollapsed));
                });

                on(applyHistoryRange, 'click', () => {
                    if (!historyRangeInput) return;
                    const raw = historyRangeInput.value.trim();
                    const value = parseInt(raw, 10);
                    if (isNaN(value) || value < 1) {
                        UI.showToast('ËØ∑ËæìÂÖ•Â§ß‰∫é0ÁöÑÊï∞Èáè');
                        return;
                    }
                    AppState.data.settings.historyCount = Math.min(value, 50);
                    DataManager.save(AppState.data);
                    UI.updateStats();
                });

                on(historyRangeInput, 'keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (applyHistoryRange) applyHistoryRange.click();
                    }
                });

                onId('closeData', 'click', () => {
                    const dataPanel = byId('dataPanel');
                    if (dataPanel) dataPanel.classList.remove('show');
                });

                onId('exportJsonBtn', 'click', () => {
                    UI.setExportMode('json');
                });

                onId('exportCsvBtn', 'click', () => {
                    UI.setExportMode('csv');
                });

                onId('confirmImport', 'click', () => {
                    const importText = byId('importText');
                    if (!importText) return;
                    const text = importText.value;
                    const preview = DataManager.previewImport(text);
                    if (!preview.ok) {
                        UI.showToast(preview.error || 'ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êï∞ÊçÆÊ†ºÂºè');
                        return;
                    }

                    const typeMap = { json: 'JSON', csv: 'CSV', list: 'Â≠¶ÁîüÂêçÂçï' };
                    const currentAssignments = Array.isArray(AppState.data.assignments) ? AppState.data.assignments.length : 0;
                    const confirmMessage = [
                        `ËØÜÂà´Á±ªÂûãÔºö${typeMap[preview.type] || preview.type}`,
                        `Â≠¶ÁîüÊï∞Ôºö${preview.students}`,
                        `‰Ωú‰∏öÊï∞Ôºö${preview.assignments}`,
                        `Â∞ÜË¶ÜÁõñÂΩìÂâçÊú¨Âú∞Êï∞ÊçÆÔºàÂΩìÂâç‰Ωú‰∏ö ${currentAssignments} È°πÔºâ`,
                        'ÊòØÂê¶ÁªßÁª≠ÂØºÂÖ•Ôºü'
                    ].join('\n');

                    if (!confirm(confirmMessage)) {
                        return;
                    }

                    const backupKey = DataManager.backupCurrentData();
                    const result = DataManager.applyImport(preview);

                    if (result.ok) {
                        AppState.data = DataManager.load();
                        const latest = AppState.getSortedAssignments()[0];
                        if (latest) {
                            AppState.setCurrentAssignment(latest.id);
                        } else {
                            AppState.currentDate = getLocalDateString(new Date());
                            const assignments = AppState.getAssignmentsForDate(AppState.currentDate);
                            AppState.currentAssignmentId = assignments.length > 0 ? assignments[0].id : null;
                        }
                        updateDateTrigger();
                        UI.renderGrid();
                        UI.showToast(backupKey ? `ÂØºÂÖ•ÊàêÂäüÔºåÂ∑≤Â§á‰ªΩ ${backupKey}` : 'ÂØºÂÖ•ÊàêÂäü');
                        const dataPanel = byId('dataPanel');
                        if (dataPanel) dataPanel.classList.remove('show');
                    } else {
                        const restored = DataManager.restoreBackup(backupKey);
                        UI.showToast(restored ? 'ÂØºÂÖ•Â§±Ë¥•ÔºåÂ∑≤Ëá™Âä®ÂõûÊªö' : 'ÂØºÂÖ•Â§±Ë¥•Ôºå‰∏îÂõûÊªöÂ§±Ë¥•');
                    }
                });

                onId('clearImport', 'click', () => {
                    const importText = byId('importText');
                    if (importText) importText.value = '';
                });

                onId('copyData', 'click', async () => {
                    const text = byId('exportText');
                    if (!text) return;
                    const value = text.value || '';
                    if (!value) {
                        UI.showToast('Ê≤°ÊúâÂèØÂ§çÂà∂ÁöÑÂÜÖÂÆπ');
                        return;
                    }

                    // ‰ºòÂÖà‰ΩøÁî®Áé∞‰ª£Ââ™Ë¥¥Êùø APIÔºõÂ§±Ë¥•Êó∂ÂõûÈÄÄÂà∞ execCommand
                    if (navigator.clipboard && window.isSecureContext) {
                        try {
                            await navigator.clipboard.writeText(value);
                            UI.showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                            return;
                        } catch (e) {
                            console.warn('Clipboard API Â§çÂà∂Â§±Ë¥•ÔºåÂ∞ùËØïÂõûÈÄÄ:', e);
                        }
                    }

                    text.select();
                    const copied = document.execCommand('copy');
                    UI.showToast(copied ? 'Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºàÂÖºÂÆπÊ®°ÂºèÔºâ' : 'Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂');
                });

                this.updateSwitches();

                // ÈîÆÁõòÂø´Êç∑ÈîÆ
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        handleEscapeAction();
                    }
                });
            },

            updateSwitches() {
                const fullnameSwitch = document.getElementById('fullnameSwitch');
                const contrastSwitch = document.getElementById('contrastSwitch');
                const animationSwitch = document.getElementById('animationSwitch');
                if (fullnameSwitch) {
                    fullnameSwitch.classList.toggle('on', AppState.data.settings.showFullname);
                    fullnameSwitch.setAttribute('aria-checked', String(!!AppState.data.settings.showFullname));
                }
                if (contrastSwitch) {
                    contrastSwitch.classList.toggle('on', AppState.data.settings.highContrast);
                    contrastSwitch.setAttribute('aria-checked', String(!!AppState.data.settings.highContrast));
                }
                if (animationSwitch) {
                    animationSwitch.classList.toggle('on', AppState.data.settings.noAnimation);
                    animationSwitch.setAttribute('aria-checked', String(!!AppState.data.settings.noAnimation));
                }
            }
        };

        // ============ ÂàùÂßãÂåñ ============
        document.addEventListener('DOMContentLoaded', () => {
            AppState.init();
            UI.renderGrid();
            Events.init();
        });
    </script>
</body>
</html>
