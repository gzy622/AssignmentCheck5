<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½œä¸šæäº¤è¿½è¸ªå·¥å…· PSA</title>
    <style>
        :root {
            --primary: #4f46e5;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: 0.15s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        html {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨è¿›åº¦æ¡ - ç¯å¢ƒæ„ŸçŸ¥ */
        .ambient-progress {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--border);
            z-index: 1000;
        }

        .ambient-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            transition: width 0.3s ease;
            width: 0%;
        }

        /* å¤´éƒ¨ */
        .header {
            background: var(--card);
            padding: 6px 12px;
            box-shadow: var(--shadow);
            z-index: 100;
            flex-shrink: 0;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0;
            gap: 8px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--primary);
            color: white;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            min-width: 32px;
            height: 18px;
        }

        .badge.success { background: var(--success); }
        .badge.warning { background: var(--warning); }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .icon-btn:hover { background: var(--bg); }
        .icon-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .icon-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* æ—¥æœŸé€‰æ‹©å™¨ */
        .date-trigger {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 13px;
            background: var(--card);
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition);
        }

        .date-trigger:hover {
            border-color: var(--primary);
        }

        .date-trigger-text {
            flex: 1;
        }

        .date-trigger-arrow {
            font-size: 10px;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        .calendar-panel {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .calendar-panel.show {
            opacity: 1;
            visibility: visible;
        }

        .calendar-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 12px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.2s ease;
        }

        .calendar-panel.show .calendar-content {
            transform: translateY(0);
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .calendar-month {
            font-size: 16px;
            font-weight: 600;
        }

        .calendar-nav {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .calendar-nav:active {
            background: var(--bg);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 4px;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
            padding: 4px 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg);
        }

        .calendar-day.other-month {
            color: var(--text-secondary);
            opacity: 0.4;
        }

        .calendar-day.today {
            font-weight: 600;
            color: var(--primary);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }

        .calendar-day .day-marker {
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .calendar-day.today .day-marker,
        .calendar-day.selected .day-marker {
            background: var(--primary);
        }

        .calendar-day.selected .day-marker {
            background: white;
        }

        .calendar-close {
            margin-top: 12px;
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-close:active {
            background: var(--bg);
        }

        .date-nav-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .date-nav {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        /* ä¸»å†…å®¹åŒº */
        .main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 8px;
            -webkit-overflow-scrolling: touch;
        }

        /* å­¦ç”Ÿç½‘æ ¼ */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            transition: var(--transition);
        }

        /* å­¦ç”Ÿå¡ç‰‡ */
        .student-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            user-select: none;
            border: 2px solid transparent;
        }

        .student-card:active {
            transform: scale(0.97);
        }

        .student-card.submitted {
            border-color: var(--success);
        }

        .student-card.late {
            border-color: var(--warning);
        }

        .student-card.missing {
            border-color: var(--danger);
        }

        .student-card {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3px;
        }

        .compact-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 2px;
            transition: var(--transition);
        }

        .student-card.submitted .compact-avatar {
            background: var(--success);
            color: white;
        }

        .student-card.late .compact-avatar {
            background: var(--warning);
            color: white;
        }

        .compact-id {
            font-size: 9px;
            color: var(--text-secondary);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .compact-score {
            position: absolute;
            top: 1px;
            right: 1px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .student-grid.fullname .student-card {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 4px 3px 3px;
            gap: 2px;
        }

        .fullname-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .student-card.submitted .fullname-avatar {
            background: var(--success);
            color: white;
        }

        .student-card.late .fullname-avatar {
            background: var(--warning);
            color: white;
        }

        .fullname-info {
            text-align: center;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            min-height: 0;
        }

        .fullname-name {
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text);
            line-height: 1.3;
            width: 100%;
        }

        .fullname-id {
            font-size: 9px;
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .fullname-score {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* è¯„åˆ†å¼¹çª— */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card);
            width: 100%;
            max-width: 420px;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 12px;
            transform: translateY(100%);
            transition: transform 0.2s ease;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-close {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
            cursor: pointer;
            font-size: 14px;
            flex-shrink: 0;
        }

        .score-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 12px;
            background: var(--bg);
            border-radius: var(--radius);
            padding: 8px 10px;
        }

        .student-info-modal {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .student-info-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .student-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-number {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 1px;
        }

        .score-section {
            background: var(--bg);
            border-radius: var(--radius);
            padding: 10px;
            margin-bottom: 8px;
        }

        .score-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
            position: relative;
        }

        .score-input {
            width: 120px;
            height: 44px;
            padding: 0;
            font-size: 22px;
            font-weight: 600;
            text-align: center;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card);
            color: var(--text);
            outline: none;
            transition: var(--transition);
            line-height: 1;
        }

        .score-input:focus {
            border-color: var(--primary);
        }

        .score-input::-webkit-outer-spin-button,
        .score-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .score-input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .score-clear-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: absolute;
            right: calc(50% - 60px - 36px);
            top: 50%;
            transform: translateY(-50%);
        }

        .score-clear-btn:active {
            background: var(--border);
        }

        .status-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .status-btn {
            padding: 10px 6px;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border);
            background: var(--card);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .status-btn.submitted { border-color: var(--success); color: var(--success); }
        .status-btn.submitted.active { background: var(--success); color: white; }
        .status-btn.late { border-color: var(--warning); color: var(--warning); }
        .status-btn.late.active { background: var(--warning); color: white; }
        .status-btn.missing { border-color: var(--danger); color: var(--danger); }
        .status-btn.missing.active { background: var(--danger); color: white; }
        .status-btn.pending { border-color: var(--text-secondary); color: var(--text-secondary); }
        .status-btn.pending.active { background: var(--text-secondary); color: white; }

        .numpad {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .numpad-row {
            display: flex;
            gap: 6px;
        }

        .numpad-btn {
            flex: 1;
            padding: 14px 8px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--card);
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .numpad-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .numpad-btn.numpad-func {
            background: var(--border);
            font-size: 18px;
        }

        .numpad-btn.numpad-primary {
            background: var(--primary);
            color: white;
        }

        body.high-contrast .numpad-btn {
            border: 2px solid var(--border);
        }

        .score-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .score-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 12px;
            font-size: 14px;
        }

        .numpad {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background: var(--bg);
            border-radius: var(--radius);
            margin-bottom: 12px;
        }

        .numpad-row {
            display: flex;
            gap: 8px;
        }

        .numpad-btn {
            flex: 1;
            padding: 16px 8px;
            font-size: 22px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--card);
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .numpad-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .numpad-btn.num {
            background: var(--card);
        }

        .numpad-btn.numpad-func {
            background: var(--border);
            font-size: 20px;
        }

        .numpad-btn.numpad-action {
            background: var(--warning);
            color: white;
            font-size: 16px;
        }

        .numpad-btn.numpad-primary {
            background: var(--primary);
            color: white;
            font-size: 16px;
        }

        body.high-contrast .numpad-btn {
            border: 2px solid var(--border);
        }

        body.high-contrast .numpad-btn.numpad-primary {
            background: var(--primary);
            color: black;
        }

        .btn {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover { opacity: 0.9; }

        .btn-secondary {
            background: var(--card);
            color: var(--text);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .settings-panel.show {
            transform: translateX(0);
        }

        .settings-header {
            background: var(--card);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .settings-section {
            background: var(--card);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }

        .settings-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-item:last-child { border-bottom: none; }

        .settings-label { font-size: 15px; }

        .settings-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* åˆ‡æ¢å¼€å…³ */
        .switch {
            width: 48px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
        }

        .switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .switch.on {
            background: var(--primary);
        }

        .switch.on::after {
            transform: translateX(22px);
        }

        /* æ–‡æœ¬åŒºåŸŸ */
        .textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: monospace;
            resize: vertical;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-group .btn { flex: 1; justify-content: center; }

        /* ç»Ÿè®¡é¢æ¿ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* æ—¥å†é¢æ¿ */
        .calendar-panel {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .calendar-panel.show {
            opacity: 1;
            visibility: visible;
        }

        .calendar-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 12px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.2s ease;
        }

        .calendar-panel.show .calendar-content {
            transform: translateY(0);
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .calendar-month {
            font-size: 16px;
            font-weight: 600;
        }

        .calendar-nav {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .calendar-nav:active {
            background: var(--bg);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 4px;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
            padding: 4px 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg);
        }

        .calendar-day.other-month {
            color: var(--text-secondary);
            opacity: 0.4;
        }

        .calendar-day.today {
            font-weight: 600;
            color: var(--primary);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }

        .calendar-day .day-marker {
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .calendar-day.today .day-marker,
        .calendar-day.selected .day-marker {
            background: var(--primary);
        }

        .calendar-day.selected .day-marker {
            background: white;
        }

        .calendar-close {
            margin-top: 12px;
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-close:active {
            background: var(--bg);
        }

        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(30, 41, 59, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* é«˜å¯¹æ¯”åº¦æ¨¡å¼ */
        body.high-contrast {
            --bg: #000000;
            --card: #111111;
            --text: #ffffff;
            --text-secondary: #aaaaaa;
            --border: #444444;
            --primary: #00ff00;
            --success: #00ff00;
            --warning: #ffff00;
            --danger: #ff0000;
        }

        body.high-contrast .student-card {
            border-width: 3px;
        }

        body.high-contrast .icon-btn,
        body.high-contrast .btn,
        body.high-contrast .date-nav {
            border-width: 2px;
        }

        /* éšè—åŠ¨ç”» */
        body.no-animation * {
            transition: none !important;
            animation: none !important;
        }

        /* å“åº”å¼ */
        @media (min-width: 768px) {
            .student-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 8px;
            }
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- ç¯å¢ƒè¿›åº¦æ¡ -->
    <div class="ambient-progress">
        <div class="ambient-progress-bar" id="progressBar"></div>
    </div>

    <!-- å¤´éƒ¨ -->
    <header class="header">
        <div class="header-top">
            <button class="date-trigger" id="dateTrigger">
                <span class="date-trigger-text" id="dateTriggerText">2026-02-03 ä»Šå¤©</span>
                <span class="date-trigger-arrow">â–¼</span>
            </button>
            <div class="date-nav-group">
                <button class="date-nav" id="prevDate" title="åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼">ğŸ‘¤</button>
                <button class="date-nav" id="nextDate" title="ç»Ÿè®¡">ğŸ“Š</button>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="menuBtn" title="èœå•">â˜°</button>
            </div>
        </div>
    </header>

    <!-- æ—¥å†é¢æ¿ -->
    <div class="calendar-panel" id="calendarPanel">
        <div class="calendar-content">
            <div class="calendar-header">
                <button class="calendar-nav" id="calendarPrevMonth">â—€</button>
                <span class="calendar-month" id="calendarMonth">2026å¹´2æœˆ</span>
                <button class="calendar-nav" id="calendarNextMonth">â–¶</button>
            </div>
            <div class="calendar-weekdays">
                <div class="calendar-weekday">æ—¥</div>
                <div class="calendar-weekday">ä¸€</div>
                <div class="calendar-weekday">äºŒ</div>
                <div class="calendar-weekday">ä¸‰</div>
                <div class="calendar-weekday">å››</div>
                <div class="calendar-weekday">äº”</div>
                <div class="calendar-weekday">å…­</div>
            </div>
            <div class="calendar-days" id="calendarDays"></div>
            <button class="calendar-close" id="calendarClose">å…³é—­</button>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <main class="main">
        <div class="student-grid" id="studentGrid"></div>
    </main>

    <!-- è¯„åˆ†å¼¹çª— -->
    <div class="modal-overlay" id="scoreModal">
        <div class="modal-content">
            <div class="score-header">
                <div class="student-info-modal">
                    <div class="student-info-avatar">?</div>
                    <div>
                        <div class="student-name" id="modalStudentName">å­¦ç”Ÿå§“å</div>
                        <div class="student-number" id="modalStudentId">å­¦å·</div>
                    </div>
                </div>
                <button class="modal-close" id="closeModal">âœ•</button>
            </div>
            
            <div class="score-section">
                <div class="score-label">çŠ¶æ€</div>
                <div class="status-options">
                    <button class="status-btn submitted" data-status="submitted">å·²äº¤</button>
                    <button class="status-btn late" data-status="late">è¿Ÿäº¤</button>
                    <button class="status-btn missing" data-status="missing">æœªäº¤</button>
                    <button class="status-btn pending" data-status="pending">å–æ¶ˆ</button>
                </div>
            </div>
            
            <div class="score-section">
                <div class="score-row">
                    <input type="text" class="score-input" id="scoreInput" placeholder="-" inputmode="none" readonly onfocus="this.removeAttribute('readonly');">
                    <button class="score-clear-btn" data-action="clear" title="æ¸…ç©º">âœ•</button>
                </div>
                <div class="numpad">
                    <div class="numpad-row">
                        <button class="numpad-btn" data-action="num">1</button>
                        <button class="numpad-btn" data-action="num">2</button>
                        <button class="numpad-btn" data-action="num">3</button>
                    </div>
                    <div class="numpad-row">
                        <button class="numpad-btn" data-action="num">4</button>
                        <button class="numpad-btn" data-action="num">5</button>
                        <button class="numpad-btn" data-action="num">6</button>
                    </div>
                    <div class="numpad-row">
                        <button class="numpad-btn" data-action="num">7</button>
                        <button class="numpad-btn" data-action="num">8</button>
                        <button class="numpad-btn" data-action="num">9</button>
                    </div>
                    <div class="numpad-row">
                        <button class="numpad-btn numpad-func" data-action="decimal">.</button>
                        <button class="numpad-btn" data-action="num">0</button>
                        <button class="numpad-btn numpad-func" data-action="backspace">âŒ«</button>
                    </div>
                </div>
            </div>
            
            <div class="score-actions">
                <button class="btn btn-secondary" id="clearScoreBtn">æ¸…é™¤åˆ†æ•°</button>
                <button class="btn btn-primary" data-action="confirm">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <span style="font-size: 18px; font-weight: 600;">è®¾ç½®</span>
            <button class="icon-btn" id="closeSettings">âœ•</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-title">æ˜¾ç¤º</div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">é«˜å¯¹æ¯”åº¦æ¨¡å¼</div>
                        <div class="settings-desc">é€‚åº”å¼ºå…‰ç¯å¢ƒ</div>
                    </div>
                    <div class="switch" id="contrastSwitch"></div>
                </div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">ç¦ç”¨åŠ¨ç”»</div>
                        <div class="settings-desc">æå‡è€æ—§è®¾å¤‡æ€§èƒ½</div>
                    </div>
                    <div class="switch" id="animationSwitch"></div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">æ•°æ®ç®¡ç†</div>
                <div class="settings-item" style="flex-direction: column; align-items: stretch; gap: 8px;">
                    <div class="settings-label">æ–°å­¦æœŸåˆå§‹åŒ–</div>
                    <div class="settings-desc">æ¸…ç©ºæ‰€æœ‰å†å²æ•°æ®ï¼Œä½†ä¿ç•™å­¦ç”Ÿåå•</div>
                    <button class="btn" id="resetDataBtn" style="margin-top: 8px; color: var(--danger); border-color: var(--danger);">
                        ğŸ—‘ï¸ é‡ç½®æ•°æ®
                    </button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">å…³äº</div>
                <div class="settings-item">
                    <div class="settings-label">ç‰ˆæœ¬</div>
                    <span style="color: var(--text-secondary);">1.0.0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div class="settings-panel" id="statsPanel">
        <div class="settings-header">
            <span style="font-size: 18px; font-weight: 600;">ç»Ÿè®¡</span>
            <button class="icon-btn" id="closeStats">âœ•</button>
        </div>
        <div class="settings-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">æ€»äººæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statSubmitted">0</div>
                    <div class="stat-label">å·²æäº¤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statRate">0%</div>
                    <div class="stat-label">æäº¤ç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAvg">-</div>
                    <div class="stat-label">å¹³å‡åˆ†</div>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">å†å²è¶‹åŠ¿ (æœ€è¿‘7æ¬¡)</div>
                <div id="historyChart" style="height: 200px; display: flex; align-items: flex-end; justify-content: space-around; padding: 20px 0;"></div>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥/å¯¼å‡ºé¢æ¿ -->
    <div class="settings-panel" id="dataPanel">
        <div class="settings-header">
            <span style="font-size: 18px; font-weight: 600;">æ•°æ®å¯¼å…¥/å¯¼å‡º</span>
            <button class="icon-btn" id="closeData">âœ•</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-title">å¯¼å…¥æ•°æ®</div>
                <div class="settings-desc" style="margin-bottom: 12px;">ç²˜è´´ JSON æ•°æ®æˆ–å­¦ç”Ÿåå•ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</div>
                <textarea class="textarea" id="importText" placeholder='{"students": [{"id": "1", "name": "å¼ ä¸‰"}], "records": {}}'></textarea>
                <div class="btn-group">
                    <button class="btn btn-primary" id="confirmImport">ç¡®è®¤å¯¼å…¥</button>
                    <button class="btn" id="clearImport">æ¸…ç©º</button>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">å¯¼å‡ºæ•°æ®</div>
                <div class="settings-desc" style="margin-bottom: 12px;">å¤åˆ¶ä¸‹æ–¹æ•°æ®è¿›è¡Œå¤‡ä»½</div>
                <textarea class="textarea" id="exportText" readonly></textarea>
                <button class="btn btn-primary" id="copyData" style="width: 100%; margin-top: 12px;">ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            </div>
        </div>
    </div>

    <!-- ä¸»èœå•é¢æ¿ -->
    <div class="settings-panel" id="menuPanel">
        <div class="settings-header">
            <span style="font-size: 18px; font-weight: 600;">èœå•</span>
            <button class="icon-btn" id="closeMenu">âœ•</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-title">æ•°æ®</div>
                <div class="settings-item" id="importItem" style="cursor: pointer;">
                    <div>
                        <div class="settings-label">å¯¼å…¥æ•°æ®</div>
                        <div class="settings-desc">ä»JSONæˆ–æ–‡æœ¬å¯¼å…¥</div>
                    </div>
                    <span style="font-size: 20px;">ğŸ“¥</span>
                </div>
                <div class="settings-item" id="exportItem" style="cursor: pointer;">
                    <div>
                        <div class="settings-label">å¯¼å‡ºæ•°æ®</div>
                        <div class="settings-desc">å¤‡ä»½æ•°æ®åˆ°å‰ªè´´æ¿</div>
                    </div>
                    <span style="font-size: 20px;">ğŸ“¤</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">æ˜¾ç¤º</div>
                <div class="settings-item" id="fullnameToggleItem" style="cursor: pointer;">
                    <div>
                        <div class="settings-label">å®Œæ•´å§“å</div>
                        <div class="settings-desc">æ˜¾ç¤ºå­¦ç”Ÿå…¨åå’Œå­¦å·</div>
                    </div>
                    <span style="font-size: 20px;">ğŸ‘¤</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">æ›´å¤š</div>
                <div class="settings-item" id="statsItem" style="cursor: pointer;">
                    <div>
                        <div class="settings-label">ç»Ÿè®¡</div>
                        <div class="settings-desc">æŸ¥çœ‹æäº¤ç»Ÿè®¡</div>
                    </div>
                    <span style="font-size: 20px;">ğŸ“Š</span>
                </div>
                <div class="settings-item" id="settingsItem" style="cursor: pointer;">
                    <div>
                        <div class="settings-label">è®¾ç½®</div>
                        <div class="settings-desc">æ˜¾ç¤ºã€æ•°æ®ç®¡ç†ç­‰</div>
                    </div>
                    <span style="font-size: 20px;">âš™ï¸</span>
                </div>
            </div>
        </div>
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <div class="toast" id="toast"></div>

    <script>
        // ============ æ•°æ®ç®¡ç† ============
        const DataManager = {
            STORAGE_KEY: 'psa_data_v1',
            
            getDefaultData() {
                return {
                    students: this.generateSampleStudents(),
                    records: {},
                    settings: {
                        highContrast: false,
                        noAnimation: false,
                        showFullname: false
                    },
                    version: '1.0.0'
                };
            },

            generateSampleStudents() {
                const names = ['å¼ æµ©å®‡', 'ç‹æ¢“æ¶µ', 'ææ¬£æ€¡', 'åˆ˜å­è½©', 'é™ˆé›¨æ¡', 'æ¨æ™¨æ›¦', 'é»„æ€çª', 'èµµæ–‡åš', 'å‘¨ä½³æ€¡', 'å´ä¿Šæ°',
                    'å¾æ¢¦æ´', 'å­™æµ©ç„¶', 'é©¬æ™“é›¯', 'æœ±å®‡èˆª', 'èƒ¡é›…å©·', 'æ—å˜‰è±ª', 'éƒ­é›¨è±', 'ä½•å­å¢¨', 'é«˜è¯—æ¶µ', 'ç½—ä¸€é¸£',
                    'æ¢é™å§', 'å®‹æ‰¿å®‡', 'éƒ‘å¿ƒæ€¡', 'è°¢å¤©ä½‘', 'éŸ©é›¨è²', 'å”å­è±ª', 'å†¯æ™“è±', 'äºå˜‰æ ‘', 'è‘£æ€çª', 'è§é€¸è¾°',
                    'ç¨‹é›¨èŒ', 'æ›¹å­æ¶µ', 'è¢è‰ºé¦¨', 'é‚“åšæ–‡', 'è®¸ä½³çª', 'å‚…æ˜è½©', 'æ²ˆæ‚¦ç³', 'æ›¾æµ©ç„¶', 'å½­é›¨æ¡', 'å•æ€è¿œ'];
                return names.map((name, i) => ({
                    id: String(i + 1).padStart(2, '0'),
                    name: name
                }));
            },

            load() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    if (data) {
                        const parsed = JSON.parse(data);
                        // åˆå¹¶é»˜è®¤è®¾ç½®
                        return { ...this.getDefaultData(), ...parsed };
                    }
                } catch (e) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                }
                return this.getDefaultData();
            },

            save(data) {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
                } catch (e) {
                    console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
                }
            },

            export() {
                const data = this.load();
                return JSON.stringify(data, null, 2);
            },

            import(jsonStr) {
                try {
                    const data = JSON.parse(jsonStr);
                    if (data.students && Array.isArray(data.students)) {
                        this.save(data);
                        return true;
                    }
                } catch (e) {
                    // å°è¯•è§£æä¸ºçº¯å­¦ç”Ÿåå•
                    const lines = jsonStr.trim().split('\n').filter(l => l.trim());
                    if (lines.length > 0) {
                        const students = lines.map((line, i) => {
                            const parts = line.trim().split(/[\s,ï¼Œ]+/);
                            if (parts.length >= 2) {
                                return { id: parts[0], name: parts[1] };
                            }
                            return { id: String(i + 1).padStart(2, '0'), name: line.trim() };
                        });
                        const existing = this.load();
                        existing.students = students;
                        this.save(existing);
                        return true;
                    }
                }
                return false;
            },

            resetRecords() {
                const data = this.load();
                data.records = {};
                this.save(data);
            }
        };

        // ============ çŠ¶æ€ç®¡ç† ============
        const AppState = {
            data: DataManager.load(),
            currentDate: (() => {
                const d = new Date();
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            })(),
            selectedStudent: null,


            init() {
                this.applySettings();
            },

            applySettings() {
                const { settings } = this.data;
                document.body.classList.toggle('high-contrast', settings.highContrast);
                document.body.classList.toggle('no-animation', settings.noAnimation);
            },

            getStudentRecord(studentId) {
                const dateRecords = this.data.records[this.currentDate] || {};
                return dateRecords[studentId] || { status: 'pending', score: null };
            },

            setStudentRecord(studentId, record) {
                if (!this.data.records[this.currentDate]) {
                    this.data.records[this.currentDate] = {};
                }
                this.data.records[this.currentDate][studentId] = record;
                DataManager.save(this.data);
            },

            getStats() {
                const students = this.data.students;
                const dateRecords = this.data.records[this.currentDate] || {};
                
                let submitted = 0, late = 0, missing = 0, totalScore = 0, scoredCount = 0;
                
                students.forEach(s => {
                    const r = dateRecords[s.id] || {};
                    if (r.status === 'submitted') submitted++;
                    else if (r.status === 'late') late++;
                    else if (r.status === 'missing') missing++;
                    
                    if (r.score !== null && r.score !== undefined) {
                        totalScore += r.score;
                        scoredCount++;
                    }
                });

                return {
                    total: students.length,
                    submitted,
                    late,
                    missing,
                    pending: students.length - submitted - late - missing,
                    rate: Math.round((submitted / students.length) * 100),
                    avgScore: scoredCount > 0 ? (totalScore / scoredCount).toFixed(1) : '-'
                };
            },

            getHistoryStats() {
                const dates = Object.keys(this.data.records).sort().slice(-7);
                return dates.map(date => {
                    const records = this.data.records[date] || {};
                    const submitted = Object.values(records).filter(r => r.status === 'submitted').length;
                    return { date, rate: Math.round((submitted / this.data.students.length) * 100) };
                });
            }
        };

        // ============ UI æ¸²æŸ“ ============
        const UI = {
            renderGrid() {
                const grid = document.getElementById('studentGrid');
                const { students, settings } = AppState.data;
                const showFullname = settings.showFullname || false;
                
                grid.className = `student-grid ${showFullname ? 'fullname' : ''}`;
                
                grid.innerHTML = students.map(student => {
                    const record = AppState.getStudentRecord(student.id);
                    const statusClass = record.status === 'submitted' ? 'submitted' : 
                                       record.status === 'late' ? 'late' : 
                                       record.status === 'missing' ? 'missing' : '';
                    
                    if (showFullname) {
                        return `
                            <div class="student-card ${statusClass}" data-id="${student.id}">
                                <div class="fullname-avatar">${student.name[0]}</div>
                                <div class="fullname-info">
                                    <div class="fullname-name">${student.name}</div>
                                    <div class="fullname-id">${student.id}å·</div>
                                </div>
                                ${record.score !== null && record.score !== undefined ? 
                                    `<div class="fullname-score">${record.score}</div>` : ''}
                            </div>
                        `;
                    } else {
                        return `
                            <div class="student-card ${statusClass}" data-id="${student.id}">
                                <div class="compact-avatar">${student.name[0]}</div>
                                <div class="compact-id">${student.id}</div>
                                ${record.score !== null && record.score !== undefined ? 
                                    `<div class="compact-score">${record.score}</div>` : ''}
                            </div>
                        `;
                    }
                }).join('');

                this.updateProgress();
            },

            updateProgress() {
                const stats = AppState.getStats();
                const progressBar = document.getElementById('progressBar');
                
                progressBar.style.width = stats.rate + '%';
            },

            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            },

            showScoreModal(student) {
                AppState.selectedStudent = student;
                const record = AppState.getStudentRecord(student.id);
                
                document.getElementById('modalStudentName').textContent = student.name;
                document.getElementById('modalStudentId').textContent = student.id + 'å·';
                document.querySelector('.student-info-avatar').textContent = student.name[0];
                
                // æ¸²æŸ“çŠ¶æ€æŒ‰é’®
                document.querySelectorAll('.status-btn').forEach(btn => {
                    // pending çŠ¶æ€è¡¨ç¤ºæœªç™»è®°ï¼Œå½“ record.status ä¸º 'pending' æˆ–ä¸å­˜åœ¨æ—¶é€‰ä¸­
                    const isPending = btn.dataset.status === 'pending';
                    const isActive = isPending 
                        ? (!record.status || record.status === 'pending')
                        : btn.dataset.status === record.status;
                    btn.classList.toggle('active', isActive);
                });
                
                // è®¾ç½®åˆ†æ•°è¾“å…¥æ¡†
                const scoreInput = document.getElementById('scoreInput');
                if (scoreInput) {
                    scoreInput.value = record.score !== null && record.score !== undefined ? record.score : '';
                }
                
                document.getElementById('scoreModal').classList.add('show');
            },

            hideScoreModal() {
                document.getElementById('scoreModal').classList.remove('show');
                AppState.selectedStudent = null;
            },

            updateStats() {
                const stats = AppState.getStats();
                document.getElementById('statTotal').textContent = stats.total;
                document.getElementById('statSubmitted').textContent = stats.submitted;
                document.getElementById('statRate').textContent = stats.rate + '%';
                document.getElementById('statAvg').textContent = stats.avgScore;

                // æ¸²æŸ“å†å²å›¾è¡¨
                const history = AppState.getHistoryStats();
                const chart = document.getElementById('historyChart');
                chart.innerHTML = history.map(h => `
                    <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                        <div style="height: ${h.rate * 1.5}px; width: 30px; background: var(--primary); border-radius: 4px 4px 0 0; opacity: 0.8;"></div>
                        <div style="font-size: 10px; margin-top: 4px; color: var(--text-secondary);">${h.date.slice(5)}</div>
                        <div style="font-size: 11px; font-weight: 600;">${h.rate}%</div>
                    </div>
                `).join('');
            }
        };

        // ============ äº‹ä»¶å¤„ç† ============
        const Events = {
            init() {
                // æ—¥å†é¢æ¿
                const calendarPanel = document.getElementById('calendarPanel');
                const dateTrigger = document.getElementById('dateTrigger');
                const calendarDays = document.getElementById('calendarDays');
                const calendarMonth = document.getElementById('calendarMonth');
                let calendarCurrentDate = new Date(AppState.currentDate);

                function formatDateLabel(date) {
                    const today = new Date();
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${y}-${m}-${d}`;

                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowStr = `${tomorrow.getFullYear()}-${String(tomorrow.getMonth() + 1).padStart(2, '0')}-${String(tomorrow.getDate()).padStart(2, '0')}`;

                    let label = `${y}-${m}-${d}`;
                    if (dateStr === todayStr) {
                        label += ' ä»Šå¤©';
                    } else if (dateStr === yesterdayStr) {
                        label += ' æ˜¨å¤©';
                    } else if (dateStr === tomorrowStr) {
                        label += ' æ˜å¤©';
                    } else {
                        label += ` ${m}/${d}`;
                    }
                    return label;
                }

                function updateDateTrigger() {
                    const date = new Date(AppState.currentDate);
                    document.getElementById('dateTriggerText').textContent = formatDateLabel(date);
                }

                function getLocalDateString(date) {
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                }

                function renderCalendar() {
                    const year = calendarCurrentDate.getFullYear();
                    const month = calendarCurrentDate.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const startDate = new Date(firstDay);
                    startDate.setDate(startDate.getDate() - firstDay.getDay());

                    calendarMonth.textContent = `${year}å¹´${month + 1}æœˆ`;
                    calendarDays.innerHTML = '';

                    const today = getLocalDateString(new Date());
                    const selected = AppState.currentDate;

                    for (let i = 0; i < 42; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);

                        const dateStr = getLocalDateString(date);
                        const dayEl = document.createElement('div');
                        dayEl.className = 'calendar-day';
                        dayEl.textContent = date.getDate();

                        if (date.getMonth() !== month) {
                            dayEl.classList.add('other-month');
                        }
                        if (dateStr === today) {
                            dayEl.classList.add('today');
                            const marker = document.createElement('span');
                            marker.className = 'day-marker';
                            dayEl.appendChild(marker);
                        }
                        if (dateStr === selected) {
                            dayEl.classList.add('selected');
                            const marker = dayEl.querySelector('.day-marker');
                            if (marker) marker.remove();
                        }

                        dayEl.addEventListener('click', () => {
                            AppState.currentDate = dateStr;
                            updateDateTrigger();
                            UI.renderGrid();
                            calendarPanel.classList.remove('show');
                        });

                        calendarDays.appendChild(dayEl);
                    }
                }

                dateTrigger.addEventListener('click', () => {
                    calendarCurrentDate = new Date(AppState.currentDate);
                    renderCalendar();
                    calendarPanel.classList.add('show');
                });

                calendarPanel.addEventListener('click', (e) => {
                    if (e.target === calendarPanel) {
                        calendarPanel.classList.remove('show');
                    }
                });

                document.getElementById('calendarPrevMonth').addEventListener('click', () => {
                    calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1);
                    renderCalendar();
                });

                document.getElementById('calendarNextMonth').addEventListener('click', () => {
                    calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1);
                    renderCalendar();
                });

                document.getElementById('calendarClose').addEventListener('click', () => {
                    calendarPanel.classList.remove('show');
                });

                updateDateTrigger();

                // å·¦æŒ‰é’®ï¼šåˆ‡æ¢å®Œæ•´å§“åæ˜¾ç¤º
                document.getElementById('prevDate').addEventListener('click', () => {
                    AppState.data.settings.showFullname = !AppState.data.settings.showFullname;
                    DataManager.save(AppState.data);
                    UI.renderGrid();
                    UI.showToast(AppState.data.settings.showFullname ? 'å®Œæ•´å§“å' : 'ç®€æ´æ¨¡å¼');
                });

                // å³æŒ‰é’®ï¼šæ‰“å¼€ç»Ÿè®¡ç•Œé¢
                document.getElementById('nextDate').addEventListener('click', () => {
                    UI.updateStats();
                    document.getElementById('statsPanel').classList.add('show');
                });

                // å­¦ç”Ÿå¡ç‰‡äº¤äº’ - ç‚¹å‡»åˆ‡æ¢çŠ¶æ€ï¼Œé•¿æŒ‰æ‰“å¼€è¯„åˆ†
                let pressStartTime = 0;
                let pressCardId = null;
                let isLongPress = false;
                let longPressTimer = null;
                let touchStartY = 0;
                let touchStartX = 0;
                const LONG_PRESS_DURATION = 500;
                const SCROLL_THRESHOLD = 8;

                // ç»Ÿä¸€å¤„ç†æ‰€æœ‰è¾“å…¥è®¾å¤‡ï¼ˆé¼ æ ‡ã€è§¦æ‘¸ã€è§¦æ§ç¬”ï¼‰
                studentGrid.addEventListener('pointerdown', (e) => {
                    const card = e.target.closest('.student-card');
                    if (!card) return;
                    if (e.pointerType === 'mouse' && e.button !== 0) return;

                    pressStartTime = Date.now();
                    pressCardId = card.dataset.id;
                    isLongPress = false;
                    
                    if (e.pointerType === 'touch') {
                        touchStartY = e.clientY;
                        touchStartX = e.clientX;
                    }

                    card.setPointerCapture(e.pointerId);

                    // å¯åŠ¨é•¿æŒ‰å®šæ—¶å™¨ï¼Œåˆ°è¾¾æ—¶é—´è‡ªåŠ¨å¼¹å‡ºè¯„åˆ†å¼¹çª—
                    longPressTimer = setTimeout(() => {
                        isLongPress = true;
                        const student = AppState.data.students.find(s => s.id === pressCardId);
                        if (student) {
                            UI.showScoreModal(student);
                        }
                    }, LONG_PRESS_DURATION);
                });

                studentGrid.addEventListener('pointerup', (e) => {
                    const card = e.target.closest('.student-card');
                    
                    // æ¸…é™¤é•¿æŒ‰å®šæ—¶å™¨
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    
                    // å¦‚æœå·²ç»è§¦å‘äº†é•¿æŒ‰ï¼Œä¸æ‰§è¡Œç‚¹å‡»æ“ä½œ
                    if (isLongPress) {
                        pressCardId = null;
                        return;
                    }
                    
                    if (!card || pressCardId !== card.dataset.id) {
                        pressCardId = null;
                        return;
                    }

                    // çŸ­æŒ‰ï¼šåˆ‡æ¢çŠ¶æ€
                    const student = AppState.data.students.find(s => s.id === pressCardId);
                    if (student) {
                        const record = AppState.getStudentRecord(pressCardId);
                        const newStatus = record.status === 'submitted' ? 'pending' : 'submitted';
                        AppState.setStudentRecord(pressCardId, { ...record, status: newStatus });
                        UI.renderGrid();
                    }

                    pressCardId = null;
                });

                studentGrid.addEventListener('pointercancel', (e) => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    pressCardId = null;
                });

                // è§¦æ‘¸è®¾å¤‡ä¸“ç”¨ï¼šæ£€æµ‹æ»‘åŠ¨ï¼Œé˜»æ­¢æ»‘åŠ¨æ—¶è§¦å‘ç‚¹å‡»
                studentGrid.addEventListener('touchmove', (e) => {
                    if (!pressCardId) return;
                    const touch = e.touches[0];
                    const deltaY = Math.abs(touch.clientY - touchStartY);
                    const deltaX = Math.abs(touch.clientX - touchStartX);
                    if (deltaY > SCROLL_THRESHOLD || deltaX > SCROLL_THRESHOLD) {
                        // æ»‘åŠ¨æ—¶å–æ¶ˆé•¿æŒ‰å’Œç‚¹å‡»
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                        pressCardId = null;
                    }
                }, { passive: true });

                // è§¦æ‘¸è®¾å¤‡ä¸“ç”¨ï¼šé˜»æ­¢ touchend åæµè§ˆå™¨åˆæˆçš„ click äº‹ä»¶
                studentGrid.addEventListener('touchend', (e) => {
                    if (pressCardId) {
                        e.preventDefault();
                    }
                    pressCardId = null;
                });

                // é˜²æ­¢å³é”®èœå•å¹²æ‰°
                studentGrid.addEventListener('contextmenu', (e) => {
                    if (e.target.closest('.student-card')) {
                        e.preventDefault();
                    }
                });

                // è¯„åˆ†å¼¹çª—
                document.getElementById('closeModal').addEventListener('click', UI.hideScoreModal);
                document.getElementById('scoreModal').addEventListener('click', (e) => {
                    if (e.target.id === 'scoreModal') UI.hideScoreModal();
                });

                // çŠ¶æ€é€‰æ‹© - ç‚¹å‡»åè‡ªåŠ¨ä¿å­˜å¹¶å…³é—­å¼¹çª—
                document.querySelectorAll('.status-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (!AppState.selectedStudent) return;
                        
                        const status = btn.dataset.status;
                        const studentId = AppState.selectedStudent.id;
                        const scoreInput = document.getElementById('scoreInput');
                        const scoreValue = scoreInput ? scoreInput.value.trim() : '';
                        const score = scoreValue === '' ? null : parseFloat(scoreValue);
                        
                        // éªŒè¯åˆ†æ•°
                        if (score !== null && (isNaN(score) || score < 0 || score > 100)) {
                            UI.showToast('è¯·è¾“å…¥0-100ä¹‹é—´çš„æ•°å­—');
                            return;
                        }
                        
                        if (status === 'pending') {
                            // å–æ¶ˆç™»è®°ï¼šåˆ é™¤è¯¥å­¦ç”Ÿçš„è®°å½•
                            if (AppState.data.records[AppState.currentDate]) {
                                delete AppState.data.records[AppState.currentDate][studentId];
                                if (Object.keys(AppState.data.records[AppState.currentDate]).length === 0) {
                                    delete AppState.data.records[AppState.currentDate];
                                }
                                DataManager.save(AppState.data);
                            }
                            UI.showToast('å·²å–æ¶ˆç™»è®°');
                        } else {
                            // æ­£å¸¸çŠ¶æ€æ›´æ–°ï¼ˆåŒ…å«åˆ†æ•°ï¼‰
                            const statusMap = { submitted: 'å·²äº¤', late: 'è¿Ÿäº¤', missing: 'æœªäº¤' };
                            const statusText = statusMap[status] || status;
                            AppState.setStudentRecord(studentId, { status, score });
                            UI.showToast(score !== null ? `å·²ç™»è®°: ${statusText} ${score}åˆ†` : `å·²ç™»è®°: ${statusText}`);
                        }
                        
                        UI.renderGrid();
                        UI.hideScoreModal();
                    });
                });

                // åˆ†æ•°è¾“å…¥
                const scoreInput = document.getElementById('scoreInput');
                if (!scoreInput) return;
                
                // é™åˆ¶è¾“å…¥èŒƒå›´ï¼ˆç”¨äºç³»ç»Ÿè¾“å…¥æ³•è¾“å…¥çš„æƒ…å†µï¼‰
                scoreInput.addEventListener('input', (e) => {
                    let value = e.target.value;
                    
                    // åªå…è®¸æ•°å­—å’Œå°æ•°ç‚¹
                    value = value.replace(/[^0-9.]/g, '');
                    
                    // ç¡®ä¿åªæœ‰ä¸€ä¸ªå°æ•°ç‚¹
                    const parts = value.split('.');
                    if (parts.length > 2) {
                        value = parts[0] + '.' + parts.slice(1).join('');
                    }
                    
                    // é™åˆ¶å°æ•°ä½æ•°ä¸º2ä½
                    if (parts.length === 2 && parts[1].length > 2) {
                        value = parseFloat(value).toFixed(2);
                    }
                    
                    // é™åˆ¶èŒƒå›´ 0-100
                    const numValue = parseFloat(value);
                    if (isNaN(numValue) || numValue > 100) {
                        value = '';
                    }
                    
                    e.target.value = value;
                });

                // æ¸…é™¤åˆ†æ•°æŒ‰é’® - ä»…æ¸…ç©ºè¾“å…¥æ¡†ï¼Œä¸ä¿å­˜
                const clearScoreBtn = document.getElementById('clearScoreBtn');
                if (!clearScoreBtn) return;
                
                clearScoreBtn.addEventListener('click', () => {
                    scoreInput.value = '';
                    scoreInput.focus();
                });

                // æ¸…ç©ºæŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.score-clear-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        scoreInput.value = '';
                        scoreInput.focus();
                    });
                });

                // æ•°å­—é”®ç›˜äº‹ä»¶å¤„ç†
                document.querySelectorAll('.numpad-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.action;
                        let value = scoreInput.value || '';

                        if (action === 'num') {
                            const num = btn.textContent;
                            if (value.length < 6) {
                                if (value === '0' && num !== '0') {
                                    value = num;
                                } else if (value !== '0' || num === '.') {
                                    value += num;
                                }
                            }
                        } else if (action === 'decimal') {
                            if (!value.includes('.')) {
                                value += value === '' ? '0.' : '.';
                            }
                        } else if (action === 'backspace') {
                            value = value.slice(0, -1);
                        } else if (action === 'clear') {
                            value = '';
                        } else if (action === 'confirm') {
                            if (value !== '') {
                                const num = parseFloat(value);
                                if (num > 100) value = '100';
                            }
                            scoreInput.value = value;
                            // è§¦å‘ä¿å­˜é€»è¾‘
                            if (!AppState.selectedStudent) return;
                            const score = value === '' ? null : parseFloat(value);
                            if (score !== null && (isNaN(score) || score < 0 || score > 100)) {
                                UI.showToast('è¯·è¾“å…¥0-100ä¹‹é—´çš„æ•°å­—');
                                return;
                            }
                            AppState.setStudentRecord(AppState.selectedStudent.id, { status: 'submitted', score });
                            UI.renderGrid();
                            UI.showToast(score !== null ? `å·²ç™»è®°: å·²äº¤ ${score}åˆ†` : 'å·²ç™»è®°: å·²äº¤');
                            UI.hideScoreModal();
                            return;
                        }

                        scoreInput.value = value;
                    });
                });

                // å›è½¦é”® - é»˜è®¤ä»¥"å·²äº¤"çŠ¶æ€ä¿å­˜ï¼ˆå…¼å®¹Windowså’ŒAndroidï¼‰
                scoreInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.keyCode === 13) {
                        e.preventDefault();
                        if (!AppState.selectedStudent) return;
                        
                        const value = scoreInput.value.trim();
                        const score = value === '' ? null : parseFloat(value);
                        
                        if (score !== null && (isNaN(score) || score < 0 || score > 100)) {
                            UI.showToast('è¯·è¾“å…¥0-100ä¹‹é—´çš„æ•°å­—');
                            return;
                        }
                        
                        // é»˜è®¤ä»¥"å·²äº¤"çŠ¶æ€ä¿å­˜
                        AppState.setStudentRecord(AppState.selectedStudent.id, { status: 'submitted', score });
                        UI.renderGrid();
                        UI.showToast(score !== null ? `å·²ç™»è®°: å·²äº¤ ${score}åˆ†` : 'å·²ç™»è®°: å·²äº¤');
                        UI.hideScoreModal();
                    }
                });

                // ä¸»èœå•
                document.getElementById('menuBtn').addEventListener('click', () => {
                    document.getElementById('menuPanel').classList.add('show');
                });

                document.getElementById('closeMenu').addEventListener('click', () => {
                    document.getElementById('menuPanel').classList.remove('show');
                });

                document.getElementById('fullnameToggleItem').addEventListener('click', () => {
                    AppState.data.settings.showFullname = !AppState.data.settings.showFullname;
                    DataManager.save(AppState.data);
                    UI.renderGrid();
                    UI.showToast(AppState.data.settings.showFullname ? 'å®Œæ•´å§“åæ¨¡å¼' : 'ç®€æ´æ¨¡å¼');
                    document.getElementById('menuPanel').classList.remove('show');
                });

                document.getElementById('importItem').addEventListener('click', () => {
                    document.getElementById('menuPanel').classList.remove('show');
                    document.getElementById('dataPanel').classList.add('show');
                    document.getElementById('importText').focus();
                });

                document.getElementById('exportItem').addEventListener('click', () => {
                    document.getElementById('menuPanel').classList.remove('show');
                    document.getElementById('exportText').value = DataManager.export();
                    document.getElementById('dataPanel').classList.add('show');
                });

                document.getElementById('statsItem').addEventListener('click', () => {
                    document.getElementById('menuPanel').classList.remove('show');
                    UI.updateStats();
                    document.getElementById('statsPanel').classList.add('show');
                });

                document.getElementById('settingsItem').addEventListener('click', () => {
                    document.getElementById('menuPanel').classList.remove('show');
                    document.getElementById('settingsPanel').classList.add('show');
                    this.updateSwitches();
                });

                // è®¾ç½®é¢æ¿
                document.getElementById('closeSettings').addEventListener('click', () => {
                    document.getElementById('settingsPanel').classList.remove('show');
                });

                // å¼€å…³
                document.getElementById('contrastSwitch').addEventListener('click', (e) => {
                    AppState.data.settings.highContrast = !AppState.data.settings.highContrast;
                    DataManager.save(AppState.data);
                    AppState.applySettings();
                    e.target.classList.toggle('on', AppState.data.settings.highContrast);
                });

                document.getElementById('animationSwitch').addEventListener('click', (e) => {
                    AppState.data.settings.noAnimation = !AppState.data.settings.noAnimation;
                    DataManager.save(AppState.data);
                    AppState.applySettings();
                    e.target.classList.toggle('on', AppState.data.settings.noAnimation);
                });

                // é‡ç½®æ•°æ®
                document.getElementById('resetDataBtn').addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²æ•°æ®å—ï¼Ÿå­¦ç”Ÿåå•å°†ä¿ç•™ã€‚')) {
                        DataManager.resetRecords();
                        AppState.data = DataManager.load();
                        UI.renderGrid();
                        UI.showToast('æ•°æ®å·²é‡ç½®');
                    }
                });

                // ç»Ÿè®¡é¢æ¿
                document.getElementById('closeStats').addEventListener('click', () => {
                    document.getElementById('statsPanel').classList.remove('show');
                });

                document.getElementById('closeData').addEventListener('click', () => {
                    document.getElementById('dataPanel').classList.remove('show');
                });

                document.getElementById('confirmImport').addEventListener('click', () => {
                    const text = document.getElementById('importText').value;
                    if (DataManager.import(text)) {
                        AppState.data = DataManager.load();
                        UI.renderGrid();
                        UI.showToast('å¯¼å…¥æˆåŠŸ');
                        document.getElementById('dataPanel').classList.remove('show');
                    } else {
                        UI.showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼');
                    }
                });

                document.getElementById('clearImport').addEventListener('click', () => {
                    document.getElementById('importText').value = '';
                });

                document.getElementById('copyData').addEventListener('click', () => {
                    const text = document.getElementById('exportText');
                    text.select();
                    document.execCommand('copy');
                    UI.showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });

                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        UI.hideScoreModal();
                        document.getElementById('menuPanel').classList.remove('show');
                        document.getElementById('settingsPanel').classList.remove('show');
                        document.getElementById('statsPanel').classList.remove('show');
                        document.getElementById('dataPanel').classList.remove('show');
                    }
                });
            },

            updateSwitches() {
                document.getElementById('contrastSwitch').classList.toggle('on', AppState.data.settings.highContrast);
                document.getElementById('animationSwitch').classList.toggle('on', AppState.data.settings.noAnimation);
            }
        };

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', () => {
            AppState.init();
            UI.renderGrid();
            Events.init();
        });
    </script>
</body>
</html>
